<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2025 NFL League Scores</title>

  <!-- Tailwind utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Preload bg for faster paint -->
  <link rel="preload" as="image" href="Assets/football-field.jpeg">

  <style>
    :root { --line: rgba(255,255,255,0.15); --theme:#2563eb; --nfl-red:#c8102e; }

    /* ------------ Font: Freshman ------------ */
    @font-face {
      font-family: 'Freshman';
      src: url('Assets/Freshman.ttf') format('truetype');
      font-weight: normal; font-style: normal; font-display: swap;
    }

    /* ------------ Background (robust mobile) ------------ */
    html, body { min-height: 100%; }
    body{
      font-family: 'Freshman', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff; margin:0; background:#0b1220; letter-spacing:.03em;
    }
    /* Lock scroll when a modal is open */
    body.no-scroll { overflow: hidden; }

    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
        url('Assets/football-field.jpeg');
      background-repeat:no-repeat; background-position:center top; background-size:cover;
      will-change:transform; transform:translateZ(0); -webkit-backface-visibility:hidden; pointer-events:none;
    }
    @media (max-width:640px){
      body::before{
        background-image:
          linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
          url('Assets/football-field-mobile.jpeg'),
          url('Assets/football-field.jpeg');
        background-position:center 20%; background-size:cover;
      }
    }

    /* ------------ Typography ------------ */
    h1,h2,h3,h4,.riddle-title{ text-transform:uppercase; letter-spacing:.05em; font-weight:900; }
    .riddle-title{ letter-spacing:.08em; }
    .text-2xl,.text-xl,.font-extrabold{ letter-spacing:.06em; }

    /* ------------ UI bits ------------ */
    .rule-key{ color:var(--nfl-red); font-weight:700; }
    .card{ background:rgba(0,0,0,.60); border:1px solid var(--line); border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .tab-btn,.pill{ background:rgba(255,255,255,.10); border:1px solid var(--line); color:#fff; transition:background .2s; text-transform:uppercase; letter-spacing:.05em; }
    .tab-btn[aria-selected="true"]{ background:var(--theme); }
    .pill{ border-radius:.75rem; }
    .avatar{ width:56px; height:56px; border-radius:50%; object-fit:cover; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }

    /* Player CARD: solid background + selectable glow */
    .player-card{
      position:relative;
      background:#0d111a;
      border:1px solid var(--line);
      border-radius:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .player-card:hover{ transform: translateY(-2px); }
    .player-card.selected{ box-shadow:0 0 0 4px rgba(245,158,11,.8), 0 10px 24px rgba(0,0,0,.6); }

    .medal-badge{
      position:absolute; top:.5rem; right:.5rem;
      width:2.25rem; height:2.25rem; border-radius:9999px;
      display:grid; place-items:center; font-size:1.125rem;
      z-index:2; pointer-events:none;
    }

    /* Modals - solid cards */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60; }
    .modal-backdrop.open{ display:flex; align-items:center; justify-content:center; }
    .modal-card { background:#111 !important; border:1px solid var(--line); border-radius:1rem; box-shadow:0 8px 20px rgba(0,0,0,.75); }

    /* Profile panel */
    .profile-panel{ width:min(900px,92vw); max-height:90vh; overflow:auto; }
    .stat-card{ background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:1rem; padding:1rem; text-align:center; }
    .close-btn{ position:absolute; top:.5rem; right:.5rem; width:40px; height:40px; border-radius:9999px; background:rgba(255,255,255,.1); border:1px solid var(--line); display:grid; place-items:center; }
    .close-btn:hover{ background:rgba(255,255,255,.2); }
    .team-pill{ display:inline-flex; align-items:center; gap:.6rem; border:1px solid var(--line); border-radius:9999px; padding:.35rem .75rem; background:rgba(255,255,255,.06); }
    .team-pill img{ width:28px; height:28px; }

    /* Next game */
    .next-game{ background:rgba(255,255,255,.05); border:1px dashed var(--line); border-radius:1rem; padding:1rem; }

    /* --- Next game row + fiery VS badge (mobile-safe) --- */
.next-row{
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* teams take equal space, VS auto */
  align-items: center;
  gap: .5rem;
}

.next-row .team{
  min-width: 0;                 /* allow child to shrink inside grid cell */
  display: flex;
  align-items: center;
  gap: .5rem;
}

.next-row .team--home{ justify-content: flex-start; }
.next-row .team--away{ justify-content: flex-end; }

.next-row .team-name{
  /* key: clamp size + ellipsis instead of wrapping into the VS */
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.vs-badge{
  font-weight:900;
  letter-spacing:.12em;
  padding:.15rem .6rem;
  border:1px solid #ff4d4d;
  border-radius:.5rem;
  color:#ff4d4d;
  text-shadow:
    0 0 6px  #ff1a1a,
    0 0 12px #ff1a1a,
    0 0 18px #ff6a00;
  box-shadow:
    0 0 10px 2px rgba(255, 0, 0, .45),
    inset 0 0 10px rgba(255, 68, 0, .55);
  animation: pulseGlow 1.8s ease-in-out infinite;
}

/* scale names & logos on very small screens */
@media (max-width: 480px){
  .next-row .team-name{ font-size: clamp(.8rem, 3.4vw, 1rem); }
  .next-row img{ width: 1.25rem; height: 1.25rem; }
}

    /* Mobile tweaks */
    @media (max-width:640px){
      header .riddle-title{ font-size:1.5rem }
      .card{ padding:1rem !important }
      .tab-btn,.pill{ font-size:1rem; padding:.5rem 1rem }
    }
  </style>
</head>
<body>
  <header class="max-w-xl mx-auto px-4 pt-6 pb-3">
    <div class="flex items-center justify-center">
      <img src="Assets/nfl-logo.png" alt="NFL" class="w-12 h-12 rounded-md shadow-lg">
    </div>
    <h1 class="riddle-title text-center font-extrabold mt-3"
        style="font-size:clamp(1.4rem, 4.8vw, 2rem); line-height:1.15;">
      2025 NFL League
      <span class="block">Regular Season</span>
    </h1>
    <p class="text-center opacity-80 text-base mt-2">Updated weekly</p>
    <div class="mt-4 flex items-center justify-center gap-3">
      <button id="rulesBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Rules</button>
      <a id="repoLink" class="text-sm underline opacity-90 hover:opacity-100" target="_blank" rel="noreferrer">View on GitHub</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24 space-y-6">
    <!-- Weekly Scores -->
    <section class="card p-5 sm:p-7">
      <div class="flex items-center justify-between">
        <h2 class="riddle-title text-2xl sm:text-3xl font-extrabold">Weekly Scores</h2>
        <div class="flex gap-2 items-center">
          <button id="totalBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm" aria-selected="true">Total</button>
          <select id="weekSelect" class="pill px-2 py-1 rounded-lg text-sm"></select>
        </div>
      </div>
      <div id="leaderboard" class="mt-5 grid-auto"></div>
    </section>

    <!-- Season Highlight -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">2024 Season Highlights</h3>
      <div id="highlight" class="mt-4 grid sm:grid-cols-2 gap-6"></div>
    </section>

    <!-- Honorary Winners -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Hall of Fame</h3>
      <div id="honorary" class="mt-4"></div>
    </section>
  </main>

  <footer class="text-center text-sm opacity-75 py-6">
    <p>&copy; <span id="copyrightYear"></span> 2025 NFL LEAGUE</p>
  </footer>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card card max-w-[600px] w-[92vw] p-6">
      <h3 class="riddle-title text-xl font-extrabold mb-3 text-center">League Rules</h3>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
        <li><span class="rule-key">Submit</span> Sunday game picks before <span class="rule-key">6 PM UK</span>.</li>
        <li>Each correct prediction earns <span class="rule-key">1 point</span>.</li>
        <li><span class="rule-key">Perfect Week:</span> all Sunday games correct = <span class="rule-key">+2 bonus</span>.</li>
        <li><span class="rule-key">Specials:</span> Thanksgiving &amp; International games score <span class="rule-key">double</span>.</li>
        <li>Ties are shared positions (<span class="rule-key">no tiebreaker</span>).</li>
      </ol>
      <div class="mt-4 text-right">
        <button id="closeRules" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- Player Profile Modal -->
  <div id="profileModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card profile-panel relative p-5 sm:p-7">
      <button class="close-btn" id="profileClose" title="Close"><span aria-hidden="true">‚úï</span></button>

      <!-- Header -->
      <div class="flex items-center gap-4">
        <img id="profAvatar" src="" alt="" class="w-20 h-20 rounded-full object-cover border border-[var(--line)]">
        <div class="min-w-0">
          <div id="profName" class="riddle-title text-2xl font-extrabold">Player</div>
          <div id="profTeam" class="mt-2"></div>
        </div>
      </div>

      <!-- Next game -->
      <div id="nextGame" class="next-game mt-4 hidden"></div>

      <!-- Stats -->
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-5">
        
        <div class="stat-card"><div class="text-xs opacity-80">Total Weeks Predicted</div><div id="statGames" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Best Week</div><div id="statBest" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Win Rate</div><div id="statWinRate" class="text-2xl font-extrabold">0%</div></div>
        
        <div class="stat-card"><div class="text-xs opacity-80">Best Team Accuracy</div><div id="statBestTeam" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Avg / Game</div><div id="statAvg" class="text-2xl font-extrabold">0.00</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Longest Streak</div><div id="statStreak" class="text-2xl font-extrabold">0</div></div>

        <div class="stat-card"><div class="text-xs opacity-80">Perfect Weeks</div><div id="statPerfect" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">NFL Regular Season Wins üèÜ</div><div id="statNFLWins" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Super Bowl Wins üåü</div><div id="statSBWins" class="text-2xl font-extrabold">0</div></div>

      </div>

      <div class="mt-5 flex items-center justify-end">
        <button id="metricHelpBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Metrics Explained</button>
      </div>

      <!-- Inline help (toggles) -->
      <div id="metricHelp" class="hidden mt-3 text-sm leading-6 bg-black/40 border border-[var(--line)] rounded-xl p-4">
        <ul class="list-disc ml-5 space-y-1">
          <li><span class="rule-key">Total Weeks Predicted</span> The number of weeks you predicted the NFL scores.</li>
          <li><span class="rule-key">Best Week</span> Your highest scoring week.</li>
          <li><span class="rule-key">Win Rate</span> The % of your played weeks with a score &gt; 0.</li>
          <li><span class="rule-key">Best Team Accuracy</span> The team you pick most accurately.</li>
          <li><span class="rule-key">Avg / Game</span> Total Points divided by Games Played.</li>
          <li><span class="rule-key">Longest Streak</span> Most consecutive weeks with a score &gt; 0.</li>
          <li><span class="rule-key">Perfect Weeks</span> Weeks where you guessed every game correctly.</li>
           <li><span class="rule-key">NFL Regular Season Wins</span> Number of NFL Regular Seasons you have won.</li>
          <li><span class="rule-key">Super Bowl Wins</span> Number of Super Bowls you have won.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
  /* ---------- Utilities ---------- */
  // Optional files: picks.json & schedule.json
  const paths = {
    players: "players.json",
    weeks:   "weeks.json",
    config:  "config.json",
    picks:   "picks.json",   // OPTIONAL ‚Äì for team accuracy
    schedule:"schedule.json" // OPTIONAL ‚Äì for next game
  };

  // Map NFL team names to logo image paths (add any others you need)
  const teamLogos = {
    "San Francisco 49ers": "Assets/san-francisco-49ers.png",
    "Seattle Seahawks": "Assets/seattle-seahawks.png",
    "Dallas Cowboys": "Assets/dallas-cowboys.png",
    "Philadelphia Eagles": "Assets/philadelphia-eagles.png",
    "Washington Redskins": "Assets/washington-redskins.png",
    "New York Giants": "Assets/new-york-giants.png",
    "Kansas City Chiefs": "Assets/kansas-city-chiefs.png",
    "New England Patriots": "Assets/new-england-patriots.png",
    "Las Vegas Raiders": "Assets/raiders.png",
    "Los Angeles Rams": "Assets/los-angeles-rams.png",
    "Tampa Bay Buccaneers": "Assets/tampa-bay-buccaneers.png",
    "Arizona Cardinals": "Assets/arizona-cardinals.png",
    "Jacksonville Jaguars": "Assets/jacksonville-jaguars.png",
    "Carolina Panthers": "Assets/carolina-panthers.png",
    "Cleveland Browns": "Assets/cleveland-browns.png",
    "Tennessee Titans": "Assets/tennessee-titans.png",
    "Indianapolis Colts": "Assets/indianapolis-colts.png",
    "Chicago Bears": "Assets/chicago-bears.png",
    "Houston Texans": "Assets/houston-texans.png",
    "Los Angeles Chargers": "Assets/los-angeles-chargers.png",
    "Baltimore Ravens": "Assets/baltimore-ravens.png",
    "Buffalo Bills": "Assets/buffalo-bills.png",
    "Cincinnati Bengals": "Assets/cincinnati-bengals.png",
    "Denver Broncos": "Assets/denver-broncos.png",
    "Detroit Lions": "Assets/detroit-lions.png",
    "Green Bay Packers": "Assets/green-bay-packers.png",
    "Minnesota Vikings": "Assets/minnesota-vikings.png",
    "New Orleans Saints": "Assets/new-orleans-saints.png",
    "New York Jets": "Assets/new-york-jets.png",
    "Pittsburgh Steelers": "Assets/pittsburgh-steelers.png",
    "Miami Dolphins": "Assets/miami-dolphins.png",
    "Atlanta Falcons": "Assets/atlanta-falcons.png"
  };

  async function loadJSON(path){
    try{
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw 0;
      return await res.json();
    }catch{
      return null; // optional files may be missing
    }
  }

    /* ---------- Compute base tables ---------- */
    function compute({ players, weeks }){
      const playersById = Object.fromEntries(players.map(p=>[p.id,p]));
      const weekNums = [...new Set((weeks||[]).map(w=>w.week))].sort((a,b)=>a-b);

      const totals = players.map(p=>({ id:p.id, name:p.name, avatar:p.avatar, total:0, perWeek:{} }));
      const idx = Object.fromEntries(totals.map(t=>[t.id,t]));

      (weeks||[]).forEach(w=>{
        const scores = w.scores || {};
        for(const [pid,pts] of Object.entries(scores)){
          const t = idx[pid]; if(!t) continue;
          const val = Number(pts);
          if(Number.isFinite(val)){
            t.total += val;
            t.perWeek[w.week] = val; // undefined = DNP; number 0+ = played
          }
        }
      });

      return { playersById, totals, weekNums };
    }

    /* ---------- Leaderboard UI ---------- */
    function medal(rank){
      if(rank===0) return {emoji:"ü•á", color:"from-yellow-400 to-yellow-600", name:"Gold"};
      if(rank===1) return {emoji:"ü•à", color:"from-gray-300 to-gray-500", name:"Silver"};
      if(rank===2) return {emoji:"ü•â", color:"from-amber-600 to-amber-800", name:"Bronze"};
      return null;
    }

    function playerCardHTML(p, rank, view, selectedWeek){
      const m = medal(rank);
      let value = p.total, label = 'Total';
      if(view==='week'){ value = p.perWeek[selectedWeek] ?? 0; label = `Week ${selectedWeek}`; }

      return `
        <article class="player-card" data-player="${p.id}">
          ${m ? `<div class="medal-badge bg-gradient-to-b ${m.color}" title="${m.name}">${m.emoji}</div>` : ''}
          <div class="p-4">
            <div class="flex items-center gap-3">
              <img src="${p.avatar}" alt="${p.name}" class="avatar border border-[var(--line)]"/>
              <div class="min-w-0">
                <div class="font-extrabold text-lg truncate">${p.name}</div>
                <button class="open-profile tab-btn mt-1 px-2 py-1 rounded-lg text-xs" data-player="${p.id}">Profile</button>
              </div>
            </div>
            <div class="mt-3 grid text-center">
              <div class="rounded-xl border border-[var(--line)] py-3">
                <div class="text-xs opacity-80">${label}</div>
                <div class="text-2xl font-extrabold">${value}</div>
              </div>
            </div>
          </div>
        </article>`;
    }

    function renderLeaderboard(totals, view, selectedWeek){
      const sorted = [...totals].sort((a,b)=>{
        if(view==='week') return ((b.perWeek[selectedWeek] ?? 0) - (a.perWeek[selectedWeek] ?? 0));
        return b.total - a.total;
      });
      const html = sorted.map((p,i)=>playerCardHTML(p,i,view,selectedWeek)).join('');
      const root = document.getElementById('leaderboard');
      root.innerHTML = html;

      // selection highlight on card tap/click (doesn't open profile)
      root.querySelectorAll('.player-card').forEach(card=>{
        card.addEventListener('click', (e)=>{
          if(e.target.closest('.open-profile')) return; // ignore when pressing the button
          card.classList.toggle('selected');
        });
      });
      // handle Profile buttons
      root.querySelectorAll('.open-profile').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          openProfile(btn.dataset.player);
        });
      });
    }

    /* ---------- Season Highlight & Honorary ---------- */
    function renderHighlight(cfg, playersById){
      const el = document.getElementById('highlight');
      if(!el) return;

      const wId = cfg?.highlight?.winner;
      const sId = cfg?.highlight?.spoon;
      const w = wId && playersById[wId];
      const s = sId && playersById[sId];

      el.innerHTML = `
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-amber-400 text-xl sm:text-2xl">
            ${cfg?.season ? `${cfg.season} Season Winner!` : 'Season Winner!'}
          </h4>
          ${ w
            ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
                 <img src="${w.avatar}" alt="${w.name}" class="w-full h-full object-cover">
               </div>
               <div class="font-extrabold text-lg">${w.name}</div>`
            : `<div class="opacity-60">TBD</div>` }
        </div>
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-xl sm:text-2xl">ü•Ñ Current Wooden Spoon Holder!</h4>
          ${ s
            ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-red-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-red-300 hover:shadow-xl">
                 <img src="${s.avatar}" alt="${s.name}" class="w-full h-full object-cover">
               </div>
               <div class="font-extrabold text-lg">${s.name}</div>`
            : `<div class="opacity-60">TBD</div>` }
        </div>
      `;
    }

    function renderHonorary(cfg, playersById){
      const el = document.getElementById('honorary');
      if(!el) return;

      const items = (cfg?.honorary || [])
        .slice()
        .sort((a,b)=> b.year - a.year)
        .map(h=>{
          const p = playersById[h.player] || { name:h.player, avatar:'Assets/football2.jpg' };
          return `
            <li class="flex flex-col items-center text-center">
              <div class="w-24 h-24 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
                <img src="${p.avatar}" alt="${p.name}" class="w-full h-full object-cover">
              </div>
              <div class="mt-2 font-semibold">${h.year} - ${p.name}</div>
            </li>`;
        }).join('');

      el.innerHTML = items
        ? `<ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${items}</ul>`
        : '<div class="opacity-60 text-center">No honorary winners yet.</div>';
    }

    /* ---------- Profile Stats & helpers ---------- */
    // Only count weeks that actually happened (at least one player scored > 0)
    function computeProfileStats(weeks, playerId, config){
      const playedWeeks = (weeks||[]).filter(w=>{
        const vals = Object.values(w.scores || {}).map(Number).filter(Number.isFinite);
        return vals.some(v => v > 0);
      });

      const perfectMap = config?.perfectWeekPoints || {}; // { "1": 14, ... }
      let total = 0, games = 0;
      let positiveWeeks = 0;
      let bestPoints = -Infinity, bestWeek = null;
      let longest = 0, current = 0;
      let perfectCount = 0;

      for(const w of playedWeeks){
        const raw = w?.scores?.[playerId];
        if(raw === undefined) continue; // DNP in a week that happened
        const v = Number(raw);
        if(!Number.isFinite(v)) continue;

        total += v;
        games += 1;

        if(v > bestPoints){ bestPoints = v; bestWeek = w.week; }

        if(v > 0){ current += 1; longest = Math.max(longest, current); positiveWeeks += 1; }
        else { current = 0; }

        // perfect week target
        let target;
        if(perfectMap[w.week] != null){
          target = Number(perfectMap[w.week]);
        } else if(w.games != null){
          target = Number(w.games);
        } else {
          const vals = Object.values(w.scores||{}).map(n=>Number(n)).filter(Number.isFinite);
          target = vals.length ? Math.max(...vals) : undefined;
        }
        if(Number.isFinite(target) && v === target && v > 0){
          perfectCount += 1;
        }
      }

      if(bestPoints === -Infinity){ bestPoints = 0; bestWeek = null; }

      return {
        totalPoints: total,
        gamesPlayed: games,
        avgPerGame: games ? total/games : 0,
        winRate: games ? Math.round((positiveWeeks / games) * 100) : 0,
        bestPoints,
        bestWeek,
        longest,
        perfectWeeks: perfectCount
      };
    }

    // Best team accuracy from picks.json
    function computeBestTeamAccuracy(picks, playerId, config){
      if(!Array.isArray(picks)) return null;

      const counts = {}; // team -> { correct: n, total: n }
      for(const wk of picks){
        for(const g of (wk.games || [])){
          const playerPick = g?.picks?.[playerId];
          if(!playerPick) continue;
          const t = (counts[playerPick] ||= { correct:0, total:0 });
          t.total += 1;
          if(g.winner && g.winner === playerPick) t.correct += 1;
        }
      }
      const minPicks = Number(config?.bestTeamMinPicks ?? 3);

      let best = null;
      for(const [team, stat] of Object.entries(counts)){
        if(stat.total < minPicks) continue;
        const pct = Math.round((stat.correct / stat.total) * 100);
        if(!best || pct > best.pct || (pct === best.pct && stat.total > best.total)){
          best = { team, pct, total: stat.total };
        }
      }
      return best; // { team, pct, total } or null
    }

    // Next upcoming game for a team (from schedule.json)
    function nextGameForTeam(schedule, teamName){
      if(!Array.isArray(schedule) || !teamName) return null;
      const now = new Date();
      const upcoming = schedule
        .map(g => ({...g, dt: new Date(g.date)}))
        .filter(g => g.dt >= now && (g.home === teamName || g.away === teamName))
        .sort((a,b) => a.dt - b.dt);
      return upcoming[0] || null;
    }

    /* ---------- Profile Modal ---------- */
    function openProfile(playerId){
      const { playersById } = window.state;
      const player = playersById[playerId];
      if(!player) return;

      const stats = computeProfileStats(window.weeks, playerId, window.config || {});
      const bestTeam = computeBestTeamAccuracy(window.picks, playerId, window.config || {});
      const next = nextGameForTeam(window.schedule, player.team);

      // Header bits
      document.getElementById('profAvatar').src = player.avatar;
      document.getElementById('profAvatar').alt = player.name;
      document.getElementById('profName').textContent = player.name;

      // Team pill
      const teamWrap = document.getElementById('profTeam');
      if(player.team || player.teamLogo){
        teamWrap.innerHTML = `
          <span class="team-pill">
            ${player.teamLogo ? `<img src="${player.teamLogo}" alt="" class="object-contain rounded-sm">` : ''}
            <span>${player.team || 'Team'}</span>
          </span>`;
      } else {
        teamWrap.innerHTML = '';
      }

      // Next game
const nextEl = document.getElementById('nextGame');
if(next){
  const opp = (next.home === player.team) ? next.away : next.home;
  const dateStr = next.dt.toLocaleString(undefined, {
    weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
  });

  nextEl.innerHTML = `
  <div class="flex items-center justify-between gap-3">
    <div class="text-sm opacity-80">Next game</div>
    <div class="text-right text-sm opacity-80">
      ${dateStr}${next.venue ? ` ¬∑ ${next.venue}` : ''}
    </div>
  </div>

  <div class="mt-2 next-row">
    <div class="team team--home">
      ${player.teamLogo ? `<img src="${player.teamLogo}" class="w-8 h-8 object-contain" alt="">` : ''}
      <span class="team-name">${player.team}</span>
    </div>

    <span class="vs-badge" aria-hidden="true">VS</span>

    <div class="team team--away">
      ${teamLogos[opp] ? `<img src="${teamLogos[opp]}" class="w-8 h-8 object-contain" alt="">` : ''}
      <span class="team-name">${opp}</span>
    </div>
  </div>
`;
  nextEl.classList.remove('hidden');
} else {
  nextEl.classList.add('hidden');
  nextEl.innerHTML = '';
}
      
      // Stats
      document.getElementById('statNFLWins').textContent =
  Number.isFinite(Number(player.nflWins)) ? Number(player.nflWins) : 0;
      document.getElementById('statGames').textContent   = stats.gamesPlayed;
      document.getElementById('statAvg').textContent     = stats.avgPerGame.toFixed(2);
      document.getElementById('statWinRate').textContent = stats.winRate + '%';
      document.getElementById('statBest').textContent    = stats.bestWeek ? `W${stats.bestWeek} (${stats.bestPoints})` : '‚Äî';
      document.getElementById('statStreak').textContent  = stats.longest;
      document.getElementById('statPerfect').textContent = stats.perfectWeeks;

      // Super Bowl wins (from players.json, optional)
      document.getElementById('statSBWins').textContent = Number.isFinite(Number(player.superbowlWins)) ? Number(player.superbowlWins) : 0;

      // Best Team Accuracy (from picks.json, optional)
      document.getElementById('statBestTeam').textContent = bestTeam
        ? `${bestTeam.team} ¬∑ ${bestTeam.pct}%`
        : '‚Äî';

      // Show modal & lock scroll
      document.getElementById('profileModal').classList.add('open');
      document.body.classList.add('no-scroll');
      document.getElementById('profileModal').setAttribute('aria-hidden','false');
    }

    /* ---------- Boot ---------- */
    (async function boot(){
      try{
        const [players, weeks, config, picks, schedule] = await Promise.all([
          loadJSON(paths.players),
          loadJSON(paths.weeks),
          loadJSON(paths.config),
          loadJSON(paths.picks),
          loadJSON(paths.schedule)
        ]);
        window.weeks = weeks || [];
        window.config = config || {};
        window.picks = picks || null;
        window.schedule = schedule || null;

        const state = compute({ players, weeks });
        window.state = state;

        // Build week dropdown (ascending) and default it to Week 1
        const weekSel = document.getElementById('weekSelect');
        const totalBtn = document.getElementById('totalBtn');

        weekSel.innerHTML = state.weekNums.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
        if(state.weekNums.length){ weekSel.value = String(state.weekNums[0]); } // Week 1

        // Initial renders
        renderLeaderboard(state.totals, 'total'); // Always start on All
        renderHighlight(config, state.playersById);
        renderHonorary(config, state.playersById);

        // Keep defaulting to All even on bfcache returns
        function resetToAll(){
          totalBtn.setAttribute('aria-selected','true');
          if(state.weekNums.length) weekSel.selectedIndex = 0; // show "Week 1"
          renderLeaderboard(state.totals, 'total');
        }
        resetToAll();
        window.addEventListener('pageshow', resetToAll);

        // Interactions
        totalBtn.addEventListener('click', ()=>{
          totalBtn.setAttribute('aria-selected','true');
          renderLeaderboard(state.totals, 'total');
        });
        weekSel.addEventListener('change', ()=>{
          totalBtn.setAttribute('aria-selected','false');
          renderLeaderboard(state.totals, 'week', Number(weekSel.value));
        });

        // Rules modal
        const rulesModal = document.getElementById('rulesModal');
        function openRules(){
          rulesModal.classList.add('open');
          document.body.classList.add('no-scroll');
          rulesModal.setAttribute('aria-hidden','false');
        }
        function closeRules(){
          rulesModal.classList.remove('open');
          document.body.classList.remove('no-scroll');
          rulesModal.setAttribute('aria-hidden','true');
        }
        document.getElementById('rulesBtn').addEventListener('click', openRules);
        document.getElementById('closeRules').addEventListener('click', closeRules);
        rulesModal.addEventListener('click', e=>{ if(e.target===rulesModal) closeRules(); });

        // Profile modal
        const profileModal = document.getElementById('profileModal');
        function closeProfile(){
          profileModal.classList.remove('open');
          document.body.classList.remove('no-scroll');
          profileModal.setAttribute('aria-hidden','true');
        }
        document.getElementById('profileClose').addEventListener('click', closeProfile);
        profileModal.addEventListener('click', e=>{ if(e.target===profileModal) closeProfile(); });

        // Metric help toggle
        const metricHelpBtn = document.getElementById('metricHelpBtn');
        const metricHelp = document.getElementById('metricHelp');
        metricHelpBtn.addEventListener('click', ()=>{
          metricHelp.classList.toggle('hidden');
        });

        // Repo link + footer year
        const repoLink = document.getElementById('repoLink');
        if(repoLink) repoLink.href = config?.repoUrl || '#';
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();

      }catch(err){
        console.error(err);
        const msg = document.createElement('div');
        msg.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
        msg.textContent = err?.message || 'Something went wrong';
        document.body.appendChild(msg);
      }
    })();
  </script>
</body>
</html>
