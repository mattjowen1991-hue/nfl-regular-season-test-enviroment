<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFL League Scores</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Preload bg -->
  <link rel="preload" as="image" href="Assets/football-field.jpeg">

  <style>
    :root { --line: rgba(255,255,255,0.15); --theme:#2563eb; --nfl-red:#c8102e; }

    /* Font â€“ Freshman */
    @font-face {
      font-family: 'Freshman';
      src: url('Assets/Freshman.ttf') format('truetype');
      font-weight: normal; font-style: normal; font-display: swap;
    }

    /* Background (robust mobile) */
    html, body { min-height:100%; }
    body{
      font-family: 'Freshman', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff; margin:0; background:#0b1220; letter-spacing:.03em;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
        url('Assets/football-field.jpeg');
      background-repeat:no-repeat; background-position:center top; background-size:cover;
      will-change:transform; transform:translateZ(0); -webkit-backface-visibility:hidden; pointer-events:none;
    }
    @media (max-width:640px){
      body::before{
        background-image:
          linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
          url('Assets/football-field-mobile.jpeg'),
          url('Assets/football-field.jpeg');
        background-position:center 20%; background-size:cover;
      }
    }

    /* Titles / numbers */
    h1,h2,h3,h4,.riddle-title{ font-family:'Freshman',sans-serif; text-transform:uppercase; letter-spacing:.05em; font-weight:900; }
    .riddle-title{ letter-spacing:.08em; }
    .text-2xl,.text-xl,.font-extrabold{ font-family:'Freshman',sans-serif; letter-spacing:.06em; }

    /* Highlights */
    .rule-key{ color:var(--nfl-red); font-weight:700; }

    /* Cards & controls */
    .card{ background:rgba(0,0,0,.60); border:1px solid var(--line); border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .tab-btn,.pill{ background:rgba(255,255,255,.10); border:1px solid var(--line); color:#fff; transition:background .2s; text-transform:uppercase; letter-spacing:.05em; }
    .tab-btn[aria-selected="true"]{ background:var(--theme); }
    .pill{ border-radius:.75rem; }
    .avatar{ width:56px; height:56px; border-radius:50%; object-fit:cover; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }

    /* Player CARD: solid background + selectable glow */
    .player-card{
      background: #0d111a;                 /* SOLID, not transparent */
      border: 1px solid var(--line);
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.5);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .player-card:hover{ transform: translateY(-2px); }
    .player-card.selected{
      box-shadow: 0 0 0 4px rgba(245, 158, 11, .8), 0 10px 24px rgba(0,0,0,.6); /* amber ring + shadow */
    }

    /* Player profile modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60; }
    .modal-backdrop.open{ display:flex; align-items:center; justify-content:center; }
    .profile-panel{ width:min(900px,92vw); max-height:90vh; overflow:auto; }
    .stat-card{ background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:1rem; padding:1rem; text-align:center; }
    .close-btn{ position:absolute; top:.5rem; right:.5rem; width:40px; height:40px; border-radius:9999px; background:rgba(255,255,255,.1); border:1px solid var(--line); display:grid; place-items:center; }
    .close-btn:hover{ background:rgba(255,255,255,.2); }
    .team-pill{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--line); border-radius:9999px; padding:.4rem .75rem; background:rgba(255,255,255,.06); }

    /* Mobile tweaks */
    @media (max-width:640px){
      header .riddle-title{ font-size:1.5rem }
      .card{ padding:1rem !important }
      .tab-btn,.pill{ font-size:1rem; padding:.5rem 1rem }
    }
  </style>
</head>
<body>
  <header class="max-w-xl mx-auto px-4 pt-6 pb-3">
    <div class="flex items-center justify-center">
      <img src="Assets/nfl-logo.png" alt="NFL" class="w-12 h-12 rounded-md shadow-lg">
    </div>
    <h1 class="riddle-title text-center font-extrabold mt-3" style="font-size:clamp(1.4rem, 4.8vw, 2rem); line-height:1.15;">
      NFL League <span class="block">Regular Season</span>
    </h1>
    <p class="text-center opacity-80 text-base mt-2">Updated weekly from JSON â€” simple to edit, zero build step.</p>
    <div class="mt-4 flex items-center justify-center gap-3">
      <button id="rulesBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Rules</button>
      <a id="repoLink" class="text-sm underline opacity-90 hover:opacity-100" target="_blank" rel="noreferrer">View on GitHub</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24 space-y-6">
    <!-- Weekly Scores -->
    <section class="card p-5 sm:p-7">
      <div class="flex items-center justify-between">
        <h2 class="riddle-title text-2xl sm:text-3xl font-extrabold">Weekly Scores</h2>
        <div class="flex gap-2 items-center">
          <button id="totalBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm" aria-selected="true">Total</button>
          <select id="weekSelect" class="pill px-2 py-1 rounded-lg text-sm"></select>
        </div>
      </div>
      <div id="leaderboard" class="mt-5 grid-auto"></div>
    </section>

    <!-- Season Highlight -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Season Highlight</h3>
      <div id="highlight" class="mt-4 grid sm:grid-cols-2 gap-6"></div>
    </section>

    <!-- Honorary Winners -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Honorary Winners</h3>
      <ul id="honorary" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></ul>
    </section>
  </main>

  <footer class="text-center text-sm opacity-75 py-6">
    <p>&copy; <span id="copyrightYear"></span> NFL League</p>
  </footer>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop">
    <div class="card p-6 max-w-[600px] mx-4">
      <h3 class="riddle-title text-xl font-extrabold mb-3 text-center">League Rules</h3>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
        <li><span class="rule-key">Submit</span> Sunday game picks before <span class="rule-key">6 PM UK</span>.</li>
        <li>Each correct prediction earns <span class="rule-key">1 point</span>.</li>
        <li><span class="rule-key">Perfect Week:</span> all Sunday games correct = <span class="rule-key">+2 bonus</span>.</li>
        <li><span class="rule-key">Specials:</span> Thanksgiving & International games score <span class="rule-key">double</span>.</li>
        <li>Ties are shared positions (<span class="rule-key">no tiebreaker</span>).</li>
      </ol>
      <div class="mt-4 text-right">
        <button id="closeRules" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- Player Profile Modal -->
  <div id="playerProfile" class="modal-backdrop">
    <div class="profile-panel card p-5 sm:p-7 relative mx-4">
      <button id="closeProfile" class="close-btn" aria-label="Close profile">âœ•</button>

      <!-- Header: avatar + name + team -->
      <div class="flex items-center gap-4">
        <img id="profAvatar" class="w-20 h-20 rounded-full ring-4 ring-amber-400 object-cover" alt="">
        <div class="min-w-0">
          <h3 id="profName" class="riddle-title text-2xl">Player</h3>
          <div id="teamRow" class="mt-2 hidden">
            <span class="team-pill">
              <img id="profTeamLogo" alt="" class="w-6 h-6 rounded-sm object-contain">
              <span id="profTeamName" class="text-sm">Team</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Stats grid -->
      <div class="grid sm:grid-cols-4 gap-4 mt-5">
        <div class="stat-card">
          <div class="text-xs opacity-80">Total Points</div>
          <div id="statTotal" class="text-2xl mt-1">0</div>
        </div>
        <div class="stat-card">
          <div class="text-xs opacity-80">Games Played</div>
          <div id="statPlayed" class="text-2xl mt-1">0</div>
        </div>
        <div class="stat-card">
          <div class="text-xs opacity-80">Avg / Game</div>
          <div id="statAvg" class="text-2xl mt-1">0.00</div>
        </div>
        <div class="stat-card">
          <div class="text-xs opacity-80">Best Week</div>
          <div id="statBest" class="text-2xl mt-1">Wâ€“ 0</div>
        </div>
      </div>

      <div class="stat-card mt-4">
        <div class="text-xs opacity-80">Longest Scoring Streak</div>
        <div id="statStreak" class="text-2xl mt-1">0 weeks</div>
      </div>

      <!-- Metrics explainer -->
      <div class="mt-5">
        <button id="metricsInfoBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">What do these mean?</button>
        <div id="metricsInfoPanel" class="hidden mt-3 card p-4">
          <ul class="list-disc pl-5 space-y-2 text-sm leading-6">
            <li><span class="rule-key">Total Points</span>: Sum of all points youâ€™ve earned this season.</li>
            <li><span class="rule-key">Games Played</span>: Weeks where you have a recorded score (missed = not counted).</li>
            <li><span class="rule-key">Avg / Game</span>: Total Points Ã· Games Played.</li>
            <li><span class="rule-key">Best Week</span>: Your single highest weekly score and which week it happened.</li>
            <li><span class="rule-key">Longest Scoring Streak</span>: Most consecutive weeks with more than 0 points.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Helpers ---------- */
    function medal(rank){
      if(rank===0) return {emoji:"ðŸ¥‡", color:"from-yellow-400 to-yellow-600", name:"Gold"};
      if(rank===1) return {emoji:"ðŸ¥ˆ", color:"from-gray-300 to-gray-500", name:"Silver"};
      if(rank===2) return {emoji:"ðŸ¥‰", color:"from-amber-600 to-amber-800", name:"Bronze"};
      return null;
    }

    function compute({ players, weeks }){
      const playersById = Object.fromEntries(players.map(p=>[p.id,p]));
      const weekNums = [...new Set(weeks.map(w=>w.week))].sort((a,b)=>a-b);

      const totals = players.map(p=>({ id:p.id, name:p.name, avatar:p.avatar, total:0, perWeek:{} }));
      const idx = Object.fromEntries(totals.map(t=>[t.id,t]));

      weeks.forEach(w=>{
        const scores = w.scores || {};
        for(const [pid,pts] of Object.entries(scores)){
          const t = idx[pid]; if(!t) continue;
          const val = Number(pts)||0;
          t.total += val;
          t.perWeek[w.week] = val; // undefined => missed week
        }
      });

      return { playersById, totals, weekNums };
    }

    function playerCard(p, rank, view, selectedWeek){
      const m = medal(rank);
      let value = p.total, label = 'Total';
      if(view==='week'){ value = p.perWeek[selectedWeek]||0; label = `Week ${selectedWeek}`; }

      return `
        <article class="player-card p-4 relative cursor-pointer" data-player="${p.id}">
          ${m ? `<div class="absolute -top-4 -right-3 bg-gradient-to-b ${m.color}
                           text-xl rounded-full w-12 h-12 grid place-items-center"
                     title="${m.name}">${m.emoji}</div>` : ''}

          <div class="flex items-center gap-3">
            <img src="${p.avatar}" alt="${p.name}" class="avatar border border-[var(--line)]"/>
            <div class="min-w-0">
              <div class="font-extrabold text-lg truncate">${p.name}</div>
            </div>
          </div>

          <div class="mt-3 grid text-center">
            <div class="rounded-xl border border-[var(--line)] py-3">
              <div class="text-xs opacity-80">${label}</div>
              <div class="text-2xl font-extrabold">${value}</div>
            </div>
          </div>

          <!-- Profile button: opens modal, does NOT select the card -->
          <div class="mt-3 flex justify-end">
            <button class="tab-btn px-3 py-1 rounded-lg text-xs" data-open-profile="${p.id}">Profile</button>
          </div>
        </article>`;
    }

    function renderLeaderboard(totals, view, selectedWeek){
      const sorted = [...totals].sort((a,b)=>{
        if(view==='week') return (b.perWeek[selectedWeek]||0) - (a.perWeek[selectedWeek]||0);
        return b.total - a.total;
      });
      const el = document.getElementById('leaderboard');
      el.innerHTML = sorted.map((p,i)=>playerCard(p,i,view,selectedWeek)).join('');

      // Click behaviors:
      const cards = [...el.querySelectorAll('[data-player]')];

      // Selecting (yellow glow) by clicking the card area
      cards.forEach(card=>{
        card.addEventListener('click', (e)=>{
          // if the click was on the Profile button, ignore (that handler below)
          if (e.target.closest('[data-open-profile]')) return;
          setSelected(card.getAttribute('data-player'));
        });
      });

      // Open profile buttons
      el.querySelectorAll('[data-open-profile]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          openProfile(btn.getAttribute('data-open-profile'));
        });
      });

      // Keep previous selection highlighted after re-render, if any
      if (window.selectedPlayerId){
        const sel = el.querySelector(`[data-player="${window.selectedPlayerId}"]`);
        if (sel) sel.classList.add('selected');
      }
    }

    function setSelected(playerId){
      window.selectedPlayerId = playerId;
      document.querySelectorAll('#leaderboard .player-card').forEach(c=>{
        c.classList.toggle('selected', c.getAttribute('data-player') === playerId);
      });
    }

    function renderHighlight(cfg, playersById){
      const el = document.getElementById('highlight'); if(!el) return;
      const wId = cfg?.highlight?.winner, sId = cfg?.highlight?.spoon;
      const w = wId && playersById[wId]; const s = sId && playersById[sId];

      el.innerHTML = `
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-amber-400 text-xl sm:text-2xl">
            ${cfg?.season ? `${cfg.season} Season Winner!` : 'Season Winner!'}
          </h4>
          ${ w ? `
            <div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg
                        transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
              <img src="${w.avatar}" alt="${w.name}" class="w-full h-full object-cover">
            </div>
            <div class="font-extrabold text-lg">${w.name}</div>` : `<div class="opacity-60">TBD</div>` }
        </div>
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-xl sm:text-2xl">ðŸ¥„ Current Wooden Spoon Holder!</h4>
          ${ s ? `
            <div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-red-400 shadow-lg
                        transition-transform duration-300 hover:scale-110 hover:ring-red-300 hover:shadow-xl">
              <img src="${s.avatar}" alt="${s.name}" class="w-full h-full object-cover">
            </div>
            <div class="font-extrabold text-lg">${s.name}</div>` : `<div class="opacity-60">TBD</div>` }
        </div>`;
    }

    function renderHonorary(cfg, playersById){
      const el = document.getElementById('honorary'); if(!el) return;
      const items = (cfg?.honorary || [])
        .slice().sort((a,b)=>b.year - a.year)
        .map(h=>{
          const p = playersById[h.player] || { name:h.player, avatar:'Assets/football2.jpg' };
          return `
            <li class="flex flex-col items-center text-center">
              <div class="w-24 h-24 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg
                          transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
                <img src="${p.avatar}" alt="${p.name}" class="w-full h-full object-cover">
              </div>
              <div class="mt-2 font-semibold">${h.year} - ${p.name}</div>
            </li>`;
        }).join('');
      el.innerHTML = items || '<div class="opacity-60 text-center">No honorary winners yet.</div>';
    }

    /* ---------- Stats for Profile ---------- */
    function calcStats(playerId){
      const { totals, weekNums, playersById } = window.state;
      const p = totals.find(t=>t.id===playerId);
      if(!p) return null;

      const scores = weekNums.map(w => Number(p.perWeek[w] ?? NaN));
      const defined = scores.filter(v => !Number.isNaN(v));
      const gamesPlayed = defined.length;
      const total = defined.reduce((a,b)=>a+b,0);
      const avg = gamesPlayed ? (total / gamesPlayed) : 0;

      // Best week
      let bestPts = -Infinity, bestWeek = null;
      weekNums.forEach((w,idx)=>{
        const v = scores[idx];
        if(!Number.isNaN(v) && v >= 0){
          if (v > bestPts){ bestPts = v; bestWeek = w; }
        }
      });
      if(bestPts===-Infinity){ bestPts = 0; bestWeek = 'â€“'; }

      // Longest scoring streak (>0)
      let cur = 0, best = 0;
      scores.forEach(v=>{
        if(!Number.isNaN(v) && v > 0){ cur += 1; best = Math.max(best, cur); }
        else { cur = 0; }
      });

      return {
        player: playersById[playerId],
        totalPoints: total,
        gamesPlayed,
        avgPerGame: avg,
        bestWeekLabel: bestWeek,
        bestWeekPoints: bestPts,
        longestStreak: best
      };
    }

    function openProfile(playerId){
      const st = calcStats(playerId); if(!st) return;
      const modal = document.getElementById('playerProfile');

      // header
      document.getElementById('profAvatar').src = st.player.avatar;
      document.getElementById('profAvatar').alt = st.player.name;
      document.getElementById('profName').textContent = st.player.name;

      // team info (optional)
      const teamRow = document.getElementById('teamRow');
      if(st.player.team && st.player.teamLogo){
        document.getElementById('profTeamLogo').src = st.player.teamLogo;
        document.getElementById('profTeamLogo').alt = st.player.team;
        document.getElementById('profTeamName').textContent = st.player.team;
        teamRow.classList.remove('hidden');
      }else{
        teamRow.classList.add('hidden');
      }

      // stats
      document.getElementById('statTotal').textContent  = st.totalPoints.toString();
      document.getElementById('statPlayed').textContent = st.gamesPlayed.toString();
      document.getElementById('statAvg').textContent    = st.avgPerGame.toFixed(2);
      document.getElementById('statBest').textContent   = (st.bestWeekLabel==='â€“' ? 'â€”' : `W${st.bestWeekLabel}: ${st.bestWeekPoints}`);
      document.getElementById('statStreak').textContent = `${st.longestStreak} week${st.longestStreak===1?'':'s'}`;

      modal.classList.add('open');
    }

    /* ---------- Data I/O ---------- */
    async function loadJSON(path){
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok) throw new Error("Failed to load "+path);
      return await res.json();
    }
    const paths = { players:"players.json", weeks:"weeks.json", config:"config.json" };

    /* ---------- Boot ---------- */
    (async function boot(){
      try{
        const [players, weeks, config] = await Promise.all([
          loadJSON(paths.players),
          loadJSON(paths.weeks),
          loadJSON(paths.config).catch(()=>({}))
        ]);

        const state = compute({ players, weeks });
        window.state = state;

        // Week dropdown (ascending), default to Week 1; "Total" is separate
        const weekSel = document.getElementById('weekSelect');
        const totalBtn = document.getElementById('totalBtn');

        weekSel.innerHTML = state.weekNums.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
        if(state.weekNums.length) weekSel.value = String(state.weekNums[0]); // Week 1

        // Initial renders
        renderHighlight(config, state.playersById);
        renderHonorary(config, state.playersById);

        // Always start on Total (also when coming back via history)
        function resetToAll(){
          totalBtn.setAttribute('aria-selected','true');
          if(state.weekNums.length) weekSel.selectedIndex = 0;
          renderLeaderboard(state.totals, 'total');
        }
        resetToAll();
        window.addEventListener('pageshow', resetToAll);

        // Interactions
        totalBtn.addEventListener('click', ()=>{
          totalBtn.setAttribute('aria-selected','true');
          renderLeaderboard(state.totals, 'total');
        });
        weekSel.addEventListener('change', ()=>{
          totalBtn.setAttribute('aria-selected','false');
          renderLeaderboard(state.totals, 'week', Number(weekSel.value));
        });

        // Repo link
        const repoLink = document.getElementById('repoLink');
        if(repoLink) repoLink.href = config.repoUrl || '#';

        // Rules modal
        const rulesModal = document.getElementById('rulesModal');
        document.getElementById('rulesBtn').addEventListener('click', ()=> rulesModal.classList.add('open'));
        document.getElementById('closeRules').addEventListener('click', ()=> rulesModal.classList.remove('open'));
        rulesModal.addEventListener('click', e=>{ if(e.target===rulesModal) rulesModal.classList.remove('open'); });

        // Profile modal close + metrics explainer toggle
        const profileModal = document.getElementById('playerProfile');
        const closeProfile = ()=> profileModal.classList.remove('open');
        document.getElementById('closeProfile').addEventListener('click', closeProfile);
        profileModal.addEventListener('click', e=>{ if(e.target===profileModal) closeProfile(); });
        window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeProfile(); });

        const infoBtn = document.getElementById('metricsInfoBtn');
        const infoPanel = document.getElementById('metricsInfoPanel');
        infoBtn.addEventListener('click', ()=> infoPanel.classList.toggle('hidden'));

        // Footer year
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();
      }catch(err){
        console.error(err);
        const msg = document.createElement('div');
        msg.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
        msg.textContent = err.message;
        document.body.appendChild(msg);
      }
    })();
  </script>
</body>
</html>
