<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFL League Scores</title>

  <!-- Tailwind utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Optional Google font preload (not used for UI text, Freshman is primary) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="image" href="Assets/football-field.jpeg">

  <style>
    :root { --line: rgba(255,255,255,0.15); --theme:#2563eb; --nfl-red:#c8102e; }

    /* ------------ Font: Freshman ------------ */
    @font-face {
      font-family: 'Freshman';
      src: url('Assets/Freshman.ttf') format('truetype');
      font-weight: normal; font-style: normal; font-display: swap;
    }

    /* ------------ Background (robust mobile) ------------ */
    html, body { min-height: 100%; }
    body{
      font-family: 'Freshman', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff; margin:0; background:#0b1220; letter-spacing:.03em;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
        url('Assets/football-field.jpeg');
      background-repeat:no-repeat; background-position:center top; background-size:cover;
      will-change:transform; transform:translateZ(0); -webkit-backface-visibility:hidden; pointer-events:none;
    }
    @media (max-width:640px){
      body::before{
        background-image:
          linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
          url('Assets/football-field-mobile.jpeg'),
          url('Assets/football-field.jpeg');
        background-position:center 20%; background-size:cover;
      }
    }

    /* ------------ Typography ------------ */
    h1,h2,h3,h4,.riddle-title{ text-transform:uppercase; letter-spacing:.05em; font-weight:900; }
    .riddle-title{ letter-spacing:.08em; }
    .text-2xl,.text-xl,.font-extrabold{ letter-spacing:.06em; }

    /* ------------ UI bits ------------ */
    .rule-key{ color:var(--nfl-red); font-weight:700; }
    .card{ background:rgba(0,0,0,.60); border:1px solid var(--line); border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .tab-btn,.pill{ background:rgba(255,255,255,.10); border:1px solid var(--line); color:#fff; transition:background .2s; text-transform:uppercase; letter-spacing:.05em; }
    .tab-btn[aria-selected="true"]{ background:var(--theme); }
    .pill{ border-radius:.75rem; }
    .avatar{ width:56px; height:56px; border-radius:50%; object-fit:cover; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }

    /* Player CARD: solid background + selectable glow */
    .player-card{
      background:#0d111a;                 /* SOLID */
      border:1px solid var(--line);
      border-radius:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .player-card:hover{ transform: translateY(-2px); }
    .player-card.selected{
      box-shadow:0 0 0 4px rgba(245,158,11,.8), 0 10px 24px rgba(0,0,0,.6);
    }

    /* Modals */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60; }
    .modal-backdrop.open{ display:flex; align-items:center; justify-content:center; }
    .modal-card { background:#111 !important; border:1px solid var(--line); border-radius:1rem; box-shadow:0 8px 20px rgba(0,0,0,.75); }

    /* Profile panel */
    .profile-panel{ width:min(900px,92vw); max-height:90vh; overflow:auto; }
    .stat-card{ background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:1rem; padding:1rem; text-align:center; }
    .close-btn{ position:absolute; top:.5rem; right:.5rem; width:40px; height:40px; border-radius:9999px; background:rgba(255,255,255,.1); border:1px solid var(--line); display:grid; place-items:center; }
    .close-btn:hover{ background:rgba(255,255,255,.2); }
    .team-pill{ display:inline-flex; align-items:center; gap:.5rem; border:1px solid var(--line); border-radius:9999px; padding:.4rem .75rem; background:rgba(255,255,255,.06); }

    /* Mobile tweaks */
    @media (max-width:640px){
      header .riddle-title{ font-size:1.5rem }
      .card{ padding:1rem !important }
      .tab-btn,.pill{ font-size:1rem; padding:.5rem 1rem }
    }
  </style>
</head>
<body>
  <header class="max-w-xl mx-auto px-4 pt-6 pb-3">
    <div class="flex items-center justify-center">
      <img src="Assets/nfl-logo.png" alt="NFL" class="w-12 h-12 rounded-md shadow-lg">
    </div>
    <h1 class="riddle-title text-center font-extrabold mt-3"
        style="font-size:clamp(1.4rem, 4.8vw, 2rem); line-height:1.15;">
      NFL League
      <span class="block">Regular Season</span>
    </h1>
    <p class="text-center opacity-80 text-base mt-2">
      Updated weekly from JSON — simple to edit, zero build step.
    </p>
    <div class="mt-4 flex items-center justify-center gap-3">
      <button id="rulesBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Rules</button>
      <a id="repoLink" class="text-sm underline opacity-90 hover:opacity-100" target="_blank" rel="noreferrer">View on GitHub</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24 space-y-6">
    <!-- Weekly Scores -->
    <section class="card p-5 sm:p-7">
      <div class="flex items-center justify-between">
        <h2 class="riddle-title text-2xl sm:text-3xl font-extrabold">Weekly Scores</h2>
        <div class="flex gap-2 items-center">
          <button id="totalBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm" aria-selected="true">Total</button>
          <select id="weekSelect" class="pill px-2 py-1 rounded-lg text-sm"></select>
        </div>
      </div>
      <div id="leaderboard" class="mt-5 grid-auto"></div>
    </section>

    <!-- Season Highlight -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Season Highlight</h3>
      <div id="highlight" class="mt-4 grid sm:grid-cols-2 gap-6"></div>
    </section>

    <!-- Honorary Winners -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Honorary Winners</h3>
      <div id="honorary" class="mt-4"></div>
    </section>
  </main>

  <footer class="text-center text-sm opacity-75 py-6">
    <p>&copy; <span id="copyrightYear"></span> NFL League</p>
  </footer>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop">
    <div class="modal-card card max-w-[600px] w-[92vw] p-6">
      <h3 class="riddle-title text-xl font-extrabold mb-3 text-center">League Rules</h3>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
        <li><span class="rule-key">Submit</span> Sunday game picks before <span class="rule-key">6 PM UK</span>.</li>
        <li>Each correct prediction earns <span class="rule-key">1 point</span>.</li>
        <li><span class="rule-key">Perfect Week:</span> all Sunday games correct = <span class="rule-key">+2 bonus</span>.</li>
        <li><span class="rule-key">Specials:</span> Thanksgiving &amp; International games score <span class="rule-key">double</span>.</li>
        <li>Ties are shared positions (<span class="rule-key">no tiebreaker</span>).</li>
      </ol>
      <div class="mt-4 text-right">
        <button id="closeRules" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- Player Profile Modal -->
  <div id="profileModal" class="modal-backdrop">
    <div class="modal-card profile-panel relative p-5 sm:p-7">
      <button class="close-btn" id="profileClose" title="Close"><span aria-hidden="true">✕</span></button>

      <div class="flex items-center gap-4">
        <img id="profAvatar" src="" alt="" class="w-20 h-20 rounded-full object-cover border border-[var(--line)]">
        <div class="min-w-0">
          <div id="profName" class="riddle-title text-2xl font-extrabold">Player</div>
          <div id="profTeam" class="mt-2"></div>
        </div>
      </div>

      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
        <div class="stat-card"><div class="text-xs opacity-80">Total Points</div><div id="statTotal" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Games Played</div><div id="statGames" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Avg / Game</div><div id="statAvg" class="text-2xl font-extrabold">0.00</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Best Week</div><div id="statBest" class="text-2xl font-extrabold">—</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Longest Streak</div><div id="statStreak" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Perfect Weeks</div><div id="statPerfect" class="text-2xl font-extrabold">0</div></div>
      </div>

      <div class="mt-5 flex items-center justify-end">
        <button id="metricHelpBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">What do these mean?</button>
      </div>

      <!-- Inline help (toggles) -->
      <div id="metricHelp" class="hidden mt-3 text-sm leading-6 bg-black/40 border border-[var(--line)] rounded-xl p-4">
        <ul class="list-disc ml-5 space-y-1">
          <li><b>Total Points</b>: Sum of all your weekly points.</li>
          <li><b>Games Played</b>: Number of weeks where you submitted a score (weeks you didn’t play are not counted).</li>
          <li><b>Avg / Game</b>: Total Points divided by Games Played.</li>
          <li><b>Best Week</b>: Your highest scoring week.</li>
          <li><b>Longest Streak</b>: Most consecutive played weeks with a score &gt; 0.</li>
          <li><b>Perfect Weeks</b>: Weeks where you guessed every game correctly (uses <code>config.perfectWeekPoints</code> or <code>weeks[i].games</code>; if neither exist, we treat a week as “perfect” when you hit that week’s top score).</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Utilities ---------- */
    const paths = { players:"players.json", weeks:"weeks.json", config:"config.json" };

    async function loadJSON(path){
      const res = await fetch(path, { cache: 'no-store' });
      if(!res.ok) throw new Error("Failed to load "+path);
      return await res.json();
    }

    /* ---------- Compute base tables ---------- */
    function compute({ players, weeks }){
      const playersById = Object.fromEntries(players.map(p=>[p.id,p]));
      const weekNums = [...new Set(weeks.map(w=>w.week))].sort((a,b)=>a-b);

      const totals = players.map(p=>({ id:p.id, name:p.name, avatar:p.avatar, total:0, perWeek:{} }));
      const idx = Object.fromEntries(totals.map(t=>[t.id,t]));

      weeks.forEach(w=>{
        const scores = w.scores || {};
        for(const [pid,pts] of Object.entries(scores)){
          const t = idx[pid]; if(!t) continue;
          const val = Number(pts);
          if(Number.isFinite(val)){
            t.total += val;
            t.perWeek[w.week] = val;  // NOTE: undefined means “didn’t play”; 0 means played but scored 0
          }
        }
      });

      return { playersById, totals, weekNums };
    }

    /* ---------- Leaderboard UI ---------- */
    function medal(rank){
      if(rank===0) return {emoji:"🥇", color:"from-yellow-400 to-yellow-600", name:"Gold"};
      if(rank===1) return {emoji:"🥈", color:"from-gray-300 to-gray-500", name:"Silver"};
      if(rank===2) return {emoji:"🥉", color:"from-amber-600 to-amber-800", name:"Bronze"};
      return null;
    }

    function playerCardHTML(p, rank, view, selectedWeek){
      const m = medal(rank);
      let value = p.total, label = 'Total';
      if(view==='week'){ value = p.perWeek[selectedWeek] ?? 0; label = `Week ${selectedWeek}`; }

      return `
        <article class="player-card" data-player="${p.id}">
          ${m ? `<div class="absolute -mt-3 -mr-3 right-0 bg-gradient-to-b ${m.color} text-xl rounded-full w-12 h-12 grid place-items-center" title="${m.name}">${m.emoji}</div>` : ''}
          <div class="p-4">
            <div class="flex items-center gap-3">
              <img src="${p.avatar}" alt="${p.name}" class="avatar border border-[var(--line)]"/>
              <div class="min-w-0">
                <div class="font-extrabold text-lg truncate">${p.name}</div>
                <button class="open-profile tab-btn mt-1 px-2 py-1 rounded-lg text-xs" data-player="${p.id}">Profile</button>
              </div>
            </div>
            <div class="mt-3 grid text-center">
              <div class="rounded-xl border border-[var(--line)] py-3">
                <div class="text-xs opacity-80">${label}</div>
                <div class="text-2xl font-extrabold">${value}</div>
              </div>
            </div>
          </div>
        </article>`;
    }

    function renderLeaderboard(totals, view, selectedWeek){
      const sorted = [...totals].sort((a,b)=>{
        if(view==='week') return ((b.perWeek[selectedWeek] ?? 0) - (a.perWeek[selectedWeek] ?? 0));
        return b.total - a.total;
      });
      const html = sorted.map((p,i)=>playerCardHTML(p,i,view,selectedWeek)).join('');
      document.getElementById('leaderboard').innerHTML = html;

      // selection highlight on card tap/click (doesn't open profile)
      document.querySelectorAll('#leaderboard .player-card').forEach(card=>{
        card.addEventListener('click', (e)=>{
          if(e.target.closest('.open-profile')) return; // ignore when pressing the button
          card.classList.toggle('selected');
        });
      });
      // handle Profile buttons
      document.querySelectorAll('#leaderboard .open-profile').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          openProfile(btn.dataset.player);
        });
      });
    }

    /* ---------- Season Highlight & Honorary ---------- */
    function renderHighlight(cfg, playersById){
      const el = document.getElementById('highlight');
      if(!el) return;

      const wId = cfg?.highlight?.winner;
      const sId = cfg?.highlight?.spoon;
      const w = wId && playersById[wId];
      const s = sId && playersById[sId];

      el.innerHTML = `
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-amber-400 text-xl sm:text-2xl">
            ${cfg?.season ? `${cfg.season} Season Winner!` : 'Season Winner!'}
          </h4>
          ${ w
            ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
                 <img src="${w.avatar}" alt="${w.name}" class="w-full h-full object-cover">
               </div>
               <div class="font-extrabold text-lg">${w.name}</div>`
            : `<div class="opacity-60">TBD</div>` }
        </div>
        <div class="text-center space-y-2">
          <h4 class="font-extrabold text-xl sm:text-2xl">🥄 Current Wooden Spoon Holder!</h4>
          ${ s
            ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-red-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-red-300 hover:shadow-xl">
                 <img src="${s.avatar}" alt="${s.name}" class="w-full h-full object-cover">
               </div>
               <div class="font-extrabold text-lg">${s.name}</div>`
            : `<div class="opacity-60">TBD</div>` }
        </div>
      `;
    }

    function renderHonorary(cfg, playersById){
      const el = document.getElementById('honorary');
      if(!el) return;

      const items = (cfg?.honorary || [])
        .slice()
        .sort((a,b)=> b.year - a.year)
        .map(h=>{
          const p = playersById[h.player] || { name:h.player, avatar:'Assets/football2.jpg' };
          return `
            <li class="flex flex-col items-center text-center">
              <div class="w-24 h-24 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
                <img src="${p.avatar}" alt="${p.name}" class="w-full h-full object-cover">
              </div>
              <div class="mt-2 font-semibold">${h.year} - ${p.name}</div>
            </li>`;
        }).join('');

      el.innerHTML = items
        ? `<ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${items}</ul>`
        : '<div class="opacity-60 text-center">No honorary winners yet.</div>';
    }

    /* ---------- Profile Stats ---------- */
    // Counts weeks as "played" only when a score exists (undefined = DNP)
    function computeProfileStats(weeks, playerId, config){
      const perfectMap = config?.perfectWeekPoints || {}; // optional { "1": 14, "2": 13, ... }

      let total = 0;
      let games = 0;
      let bestPoints = -Infinity;
      let bestWeek = null;
      let longest = 0, current = 0;
      let perfectCount = 0;

      for(const w of weeks){
        const score = w?.scores?.[playerId];
        if(score === undefined) continue;     // DNP: not counted
        const v = Number(score);
        if(!Number.isFinite(v)) continue;

        total += v;
        games += 1;

        // best week
        if(v > bestPoints){ bestPoints = v; bestWeek = w.week; }

        // streak (strictly > 0)
        if(v > 0){ current += 1; longest = Math.max(longest, current); }
        else { current = 0; }

        // perfect weeks:
        // 1) explicit config.perfectWeekPoints[week]
        // 2) or weeks[i].games (if present)
        // 3) else fallback: v equals max score in that week (and > 0)
        let target = undefined;
        if(perfectMap[w.week] != null){
          target = Number(perfectMap[w.week]);
        } else if(w.games != null){
          target = Number(w.games);
        } else {
          // fallback: compute max for this week
          const vals = Object.values(w.scores||{}).map(n=>Number(n)).filter(n=>Number.isFinite(n));
          const max = vals.length ? Math.max(...vals) : undefined;
          target = max;
        }
        if(Number.isFinite(target) && v === target && v > 0){
          perfectCount += 1;
        }
      }

      if(bestPoints === -Infinity){ bestPoints = 0; bestWeek = null; }

      return {
        totalPoints: total,
        gamesPlayed: games,
        avgPerGame: games ? total/games : 0,
        bestPoints,
        bestWeek,        // number or null
        longest,         // streak length
        perfectWeeks: perfectCount
      };
    }

    /* ---------- Profile Modal ---------- */
    function openProfile(playerId){
      const { playersById } = window.state;
      const player = playersById[playerId];
      if(!player) return;

      const stats = computeProfileStats(window.weeks, playerId, window.config || {});

      // Header bits
      document.getElementById('profAvatar').src = player.avatar;
      document.getElementById('profAvatar').alt = player.name;
      document.getElementById('profName').textContent = player.name;

      // Team pill (optional in players.json)
      const teamWrap = document.getElementById('profTeam');
      if(player.team || player.teamLogo){
        teamWrap.innerHTML = `
          <span class="team-pill">
            ${player.teamLogo ? `<img src="${player.teamLogo}" alt="" class="w-5 h-5 object-contain rounded-sm">` : ''}
            <span>${player.team || 'Team'}</span>
          </span>`;
      } else {
        teamWrap.innerHTML = '';
      }

      // Stats
      document.getElementById('statTotal').textContent   = stats.totalPoints;
      document.getElementById('statGames').textContent   = stats.gamesPlayed;
      document.getElementById('statAvg').textContent     = stats.avgPerGame.toFixed(2);
      document.getElementById('statBest').textContent    = stats.bestWeek ? `W${stats.bestWeek} (${stats.bestPoints})` : '—';
      document.getElementById('statStreak').textContent  = stats.longest;
      document.getElementById('statPerfect').textContent = stats.perfectWeeks;

      // Show modal
      document.getElementById('profileModal').classList.add('open');
    }

    /* ---------- Boot ---------- */
    (async function boot(){
      try{
        const [players, weeks, config] = await Promise.all([
          loadJSON(paths.players),
          loadJSON(paths.weeks),
          loadJSON(paths.config).catch(()=>({}))
        ]);
        window.weeks = weeks;
        window.config = config;

        const state = compute({ players, weeks });
        window.state = state;

        // Build week dropdown (ascending) and default it to Week 1
        const weekSel = document.getElementById('weekSelect');
        const totalBtn = document.getElementById('totalBtn');

        weekSel.innerHTML = state.weekNums.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
        if(state.weekNums.length){ weekSel.value = String(state.weekNums[0]); } // Week 1

        // Initial renders
        renderLeaderboard(state.totals, 'total'); // Always start on All
        renderHighlight(config, state.playersById);
        renderHonorary(config, state.playersById);

        // Keep defaulting to All even on bfcache returns
        function resetToAll(){
          totalBtn.setAttribute('aria-selected','true');
          if(state.weekNums.length) weekSel.selectedIndex = 0; // show "Week 1"
          renderLeaderboard(state.totals, 'total');
        }
        resetToAll();
        window.addEventListener('pageshow', resetToAll);

        // Interactions
        totalBtn.addEventListener('click', ()=>{
          totalBtn.setAttribute('aria-selected','true');
          renderLeaderboard(state.totals, 'total');
        });
        weekSel.addEventListener('change', ()=>{
          totalBtn.setAttribute('aria-selected','false');
          renderLeaderboard(state.totals, 'week', Number(weekSel.value));
        });

        // Rules modal
        const rulesModal = document.getElementById('rulesModal');
        document.getElementById('rulesBtn').addEventListener('click', ()=> rulesModal.classList.add('open'));
        document.getElementById('closeRules').addEventListener('click', ()=> rulesModal.classList.remove('open'));
        rulesModal.addEventListener('click', e=>{ if(e.target===rulesModal) rulesModal.classList.remove('open'); });

        // Profile modal
        const profileModal = document.getElementById('profileModal');
        document.getElementById('profileClose').addEventListener('click', ()=> profileModal.classList.remove('open'));
        profileModal.addEventListener('click', e=>{ if(e.target===profileModal) profileModal.classList.remove('open'); });

        // Metric help toggle
        const metricHelpBtn = document.getElementById('metricHelpBtn');
        const metricHelp = document.getElementById('metricHelp');
        metricHelpBtn.addEventListener('click', ()=>{
          metricHelp.classList.toggle('hidden');
        });

        // Repo link + footer year
        const repoLink = document.getElementById('repoLink');
        if(repoLink) repoLink.href = config.repoUrl || '#';
        document.getElementById('copyrightYear').textContent = new Date().getFullYear();

      }catch(err){
        console.error(err);
        const msg = document.createElement('div');
        msg.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
        msg.textContent = err.message;
        document.body.appendChild(msg);
      }
    })();
  </script>
</body>
</html>
