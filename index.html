<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2025 NFL League Scores</title>

  <!-- Tailwind utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Preload bg for faster paint -->
  <link rel="preload" as="image" href="Assets/football-field.jpeg">

  <style>
    :root { --line: rgba(255,255,255,0.15); --theme:#2563eb; --nfl-red:#c8102e; --gold: #d4af37; }

    /* ------------ Font: Freshman ------------ */
    @font-face {
      font-family: 'Freshman';
      src: url('Assets/Freshman.ttf') format('truetype');
      font-weight: normal; font-style: normal; font-display: swap;
    }

    /* ------------ Background (robust mobile) ------------ */
    html, body { min-height: 100%; }
    body{
      font-family: 'Freshman', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff; margin:0; background:#0b1220; letter-spacing:.03em;
    }
    /* Lock scroll when a modal is open */
    body.no-scroll { overflow: hidden; }

    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
        url('Assets/football-field.jpeg');
      background-repeat:no-repeat; background-position:center top; background-size:cover;
      will-change:transform; transform:translateZ(0); -webkit-backface-visibility:hidden; pointer-events:none;
    }
    @media (max-width:640px){
      body::before{
        background-image:
          linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.85)),
          url('Assets/football-field-mobile.jpeg'),
          url('Assets/football-field.jpeg');
        background-position:center 20%; background-size:cover;
      }
    }

    /* ------------ Typography ------------ */
    h1,h2,h3,h4,.riddle-title{ text-transform:uppercase; letter-spacing:.05em; font-weight:900; }
    .riddle-title{ letter-spacing:.08em; }
    .text-2xl,.text-xl,.font-extrabold{ letter-spacing:.06em; }

    /* ------------ UI bits ------------ */
    .rule-key{ color:var(--nfl-red); font-weight:700; }
    .card{ background:rgba(0,0,0,.60); border:1px solid var(--line); border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .tab-btn,.pill{ background:rgba(255,255,255,.10); border:1px solid var(--line); color:#fff; transition:background .2s; text-transform:uppercase; letter-spacing:.05em; }
    .tab-btn[aria-selected="true"]{ background:var(--theme); }
    .pill{ border-radius:.75rem; }
    .avatar{ width:56px; height:56px; border-radius:50%; object-fit:cover; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }

    /* Player CARD: solid background + selectable glow */
    .player-card{
      position:relative;
      background:#0d111a;
      border:1px solid var(--line);
      border-radius:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .player-card:hover{ transform: translateY(-2px); }
    .player-card.selected{ box-shadow:0 0 0 4px rgba(245,158,11,.8), 0 10px 24px rgba(0,0,0,.6); }

    .medal-badge{
      position:absolute; top:.5rem; right:.5rem;
      width:2.25rem; height:2.25rem; border-radius:9999px;
      display:grid; place-items:center; font-size:1.125rem;
      z-index:2; pointer-events:none;
    }

    /* Modals - solid cards */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60; }
    .modal-backdrop.open{ display:flex; align-items:center; justify-content:center; }
    .modal-card { background:#111 !important; border:1px solid var(--line); border-radius:1rem; box-shadow:0 8px 20px rgba(0,0,0,.75); }

    /* Profile panel */
    .profile-panel{ width:min(900px,92vw); max-height:90vh; overflow:auto; }
    .stat-card{ background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:1rem; padding:1rem; text-align:center; }
    .close-btn{ position:absolute; top:.5rem; right:.5rem; width:40px; height:40px; border-radius:9999px; background:rgba(255,255,255,.1); border:1px solid var(--line); display:grid; place-items:center; }
    .close-btn:hover{ background:rgba(255,255,255,.2); }
    .team-pill{ display:inline-flex; align-items:center; gap:.6rem; border:1px solid var(--line); border-radius:9999px; padding:.35rem .75rem; background:rgba(255,255,255,.06); }
    .team-pill img{ width:28px; height:28px; }

    /* Next game */
    .next-game{ background:rgba(255,255,255,.05); border:1px dashed var(--line); border-radius:1rem; padding:1rem; }

    /* --- Next game row + fiery VS badge (mobile-safe) --- */
    .next-row{
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* teams take equal space, VS auto */
      align-items: center;
      gap: .5rem;
    }
    .next-row .team{
      min-width: 0;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .next-row .team--home{ justify-content: flex-start; }
    .next-row .team--away{ justify-content: flex-end; }
    .next-row .team-name{
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .vs-badge{
      font-weight:900;
      letter-spacing:.12em;
      padding:.15rem .6rem;
      border:1px solid #ff4d4d;
      border-radius:.5rem;
      color:#ff4d4d;
      text-shadow:
        0 0 6px  #ff1a1a,
        0 0 12px #ff1a1a,
        0 0 18px #ff6a00;
      box-shadow:
        0 0 10px 2px rgba(255, 0, 0, .45),
        inset 0 0 10px rgba(255, 68, 0, .55);
      animation: pulseGlow 1.8s ease-in-out infinite;
    }
    @media (max-width: 480px){
      .next-row .team-name{ font-size: clamp(.8rem, 3.4vw, 1rem); }
      .next-row img{ width: 1.25rem; height: 1.25rem; }
    }

    /* ============ PRIZE POT ============ */
    .prize-pot-section {
      margin-bottom: 1.5rem;
    }
    
    .prize-pot-container {
      position: relative;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
      border: 2px solid var(--gold);
      border-radius: 1.5rem;
      padding: 2rem;
      overflow: hidden;
      box-shadow: 
        0 0 30px rgba(212, 175, 55, 0.3),
        inset 0 0 60px rgba(0, 0, 0, 0.5);
    }
    
    .prize-pot-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        from 0deg,
        transparent 0deg,
        rgba(212, 175, 55, 0.1) 60deg,
        transparent 120deg
      );
      animation: rotateBg 10s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rotateBg {
      to { transform: rotate(360deg); }
    }
    
    .prize-pot-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    .trophy-icon {
      font-size: 4rem;
      filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
      animation: trophyBounce 2s ease-in-out infinite;
    }
    
    @keyframes trophyBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-10px) scale(1.05); }
    }
    
    .prize-label {
      font-family: 'Freshman', sans-serif;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .prize-amount {
      font-family: 'Freshman', sans-serif;
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd700, #ffec8b, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
      animation: amountPulse 3s ease-in-out infinite;
    }
    
    @keyframes amountPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.02); opacity: 0.9; }
    }
    
    .prize-subtitle {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }
    
    /* Falling money animation */
    .money-rain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    
    .money {
      position: absolute;
      top: -50px;
      font-size: 1.5rem;
      opacity: 0.6;
      animation: fall linear infinite;
    }
    
    @keyframes fall {
      0% {
        transform: translateY(-50px) rotate(0deg);
        opacity: 0.8;
      }
      100% {
        transform: translateY(300px) rotate(360deg);
        opacity: 0;
      }
    }
    
    .money:nth-child(1) { left: 10%; animation-duration: 3s; animation-delay: 0s; }
    .money:nth-child(2) { left: 25%; animation-duration: 3.5s; animation-delay: 0.5s; }
    .money:nth-child(3) { left: 40%; animation-duration: 2.8s; animation-delay: 1s; }
    .money:nth-child(4) { left: 55%; animation-duration: 3.2s; animation-delay: 0.3s; }
    .money:nth-child(5) { left: 70%; animation-duration: 3.7s; animation-delay: 0.8s; }
    .money:nth-child(6) { left: 85%; animation-duration: 3s; animation-delay: 1.2s; }
    .money:nth-child(7) { left: 5%; animation-duration: 3.3s; animation-delay: 1.5s; }
    .money:nth-child(8) { left: 95%; animation-duration: 2.9s; animation-delay: 0.2s; }
    
    /* Responsive */
    @media (max-width: 640px) {
      .prize-amount {
        font-size: 2.5rem;
      }
      .trophy-icon {
        font-size: 3rem;
      }
      .prize-pot-container {
        padding: 1.5rem;
      }
    }

    /* Mobile tweaks */
    @media (max-width:640px){
      header .riddle-title{ font-size:1.5rem }
      .card{ padding:1rem !important }
      .tab-btn,.pill{ font-size:1rem; padding:.5rem 1rem }
    }
  </style>
</head>
<body>
  <header class="max-w-xl mx-auto px-4 pt-6 pb-3">
    <div class="flex items-center justify-center">
      <img src="Assets/nfl-logo.png" alt="NFL" class="w-12 h-12 rounded-md shadow-lg">
    </div>
    <h1 class="riddle-title text-center font-extrabold mt-3"
        style="font-size:clamp(1.4rem, 4.8vw, 2rem); line-height:1.15;">
      2025 NFL League
      <span class="block">Regular Season</span>
    </h1>
    <p class="text-center opacity-80 text-base mt-2">Updated weekly</p>
    <div class="mt-4 flex items-center justify-center gap-3">
      <button id="rulesBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Rules</button>
      <a id="repoLink" class="text-sm underline opacity-90 hover:opacity-100" target="_blank" rel="noreferrer">View on GitHub</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-24 space-y-6">
    
    <!-- Prize Pot -->
    <section class="prize-pot-section">
      <div class="prize-pot-container">
        <div class="money-rain">
          <span class="money">üíµ</span>
          <span class="money">üí∑</span>
          <span class="money">üí∞</span>
          <span class="money">üíµ</span>
          <span class="money">üí∑</span>
          <span class="money">üí∞</span>
          <span class="money">üíµ</span>
          <span class="money">üí∑</span>
        </div>
        <div class="prize-pot-inner">
          <div class="trophy-icon">üèÜ</div>
          <div class="prize-label">Winner Takes All</div>
          <div class="prize-amount">¬£120</div>
          <div class="prize-subtitle">12 Players √ó ¬£10 Entry</div>
        </div>
      </div>
    </section>

    <!-- Weekly Scores -->
    <section class="card p-5 sm:p-7">
    <div class="flex flex-col items-center sm:flex-row justify-between gap-4 sm:gap-0">
        <h2 class="riddle-title text-2xl sm:text-3xl font-extrabold">Weekly Scores</h2>
        <div class="flex gap-2 items-center">
          <button id="totalBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm" aria-selected="true">Total</button>
          <select id="weekSelect" class="pill px-2 py-1 rounded-lg text-sm"></select>
        </div>
      </div>
      <div id="leaderboard" class="mt-5 grid-auto"></div>
    </section>

    <!-- Season Highlight -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">2024 Season Highlights</h3>
      <div id="highlight" class="mt-4 grid sm:grid-cols-2 gap-6"></div>
    </section>

    <!-- Honorary Winners -->
    <section class="card p-5 sm:p-7">
      <h3 class="riddle-title text-xl sm:text-2xl font-extrabold">Hall of Fame</h3>
      <div id="honorary" class="mt-4"></div>
    </section>
  </main>

  <footer class="text-center text-sm opacity-75 py-6">
    <p>&copy; <span id="copyrightYear"></span> 2025 NFL LEAGUE</p>
  </footer>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card card max-w-[600px] w-[92vw] p-6">
      <h3 class="riddle-title text-xl font-extrabold mb-3 text-center">League Rules</h3>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6">
        <li><span class="rule-key">Submit</span> Sunday game picks before <span class="rule-key">6 PM UK</span>.</li>
        <li>Each correct prediction earns <span class="rule-key">1 point</span>.</li>
        <li><span class="rule-key">Perfect Week:</span> all Sunday games correct = <span class="rule-key">+2 bonus</span>.</li>
        <li><span class="rule-key">Specials:</span> Thanksgiving &amp; International games score <span class="rule-key">double</span>.</li>
        <li>Ties are shared positions (<span class="rule-key">no tiebreaker</span>).</li>
      </ol>
      <div class="mt-4 text-right">
        <button id="closeRules" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- Player Stats Modal -->
  <div id="profileModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card profile-panel relative p-5 sm:p-7">
      <button class="close-btn" id="profileClose" title="Close player stats"><span aria-hidden="true">‚úï</span></button>

      <!-- Header -->
      <div class="flex items-center gap-4">
        <img id="profAvatar" src="" alt="" class="w-20 h-20 rounded-full object-cover border border-[var(--line)]">
        <div class="min-w-0">
          <div id="profName" class="riddle-title text-2xl font-extrabold">Player</div>
          <div id="profTeam" class="mt-2"></div>
        </div>
      </div>

      <!-- Next game -->
      <div id="nextGame" class="next-game mt-4 hidden"></div>

      <!-- Stats -->
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-5">
        <div class="stat-card"><div class="text-xs opacity-80">Win Rate üéØ</div><div id="statWinRate" class="text-2xl font-extrabold">0%</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Best Team Accuracy</div><div id="statBestTeam" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Correct Picks</div><div id="statCorrectPicks" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Most Picked Team</div><div id="statMostPicked" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Current Form</div><div id="statCurrentForm" class="text-2xl font-extrabold">‚Äî</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Perfect Weeks üëåüèº</div><div id="statPerfect" class="text-2xl font-extrabold">0</div></div>
      </div>
      <div class="grid sm:grid-cols-2 gap-4 mt-4">
        <div class="stat-card"><div class="text-xs opacity-80">NFL Regular Season Wins üèÜ</div><div id="statNFLWins" class="text-2xl font-extrabold">0</div></div>
        <div class="stat-card"><div class="text-xs opacity-80">Super Bowl Wins üåü</div><div id="statSBWins" class="text-2xl font-extrabold">0</div></div>
      </div>

      <div class="mt-5 flex items-center justify-end">
        <button id="metricHelpBtn" class="tab-btn px-3 py-1.5 rounded-lg text-sm">Metrics Explained</button>
      </div>

      <!-- Inline help (toggles) -->
      <div id="metricHelp" class="hidden mt-3 text-sm leading-6 bg-black/40 border border-[var(--line)] rounded-xl p-4">
        <ul class="list-disc ml-5 space-y-1">
          <li><span class="rule-key">Win Rate</span> % of your game picks that were correct.</li>
          <li><span class="rule-key">Best Team Accuracy</span> The team you predict most accurately (min 5 picks).</li>
          <li><span class="rule-key">Correct Picks</span> Total correct picks out of total picks made.</li>
          <li><span class="rule-key">Most Picked Team</span> The team you pick most often to win.</li>
          <li><span class="rule-key">Current Form</span> Your last 5 weeks: üü¢ = above average, üî¥ = below average.</li>
          <li><span class="rule-key">Perfect Weeks</span> Weeks where you guessed every game correctly.</li>
          <li><span class="rule-key">NFL Regular Season Wins</span> Number of league seasons you have won.</li>
          <li><span class="rule-key">Super Bowl Wins</span> Number of playoff championships you have won.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
  /* ============================================
     JSONBIN CONFIGURATION
     ============================================ */
  const JSONBIN_CONFIG = {
    // League Scores Bin ID - same as admin dashboard
    SCORES_BIN_ID: '6951c2b0ae596e708fb6c625',
    // Picks History Bin ID - for detailed stats
    PICKS_HISTORY_BIN_ID: '695317c4ae596e708fb8f9ec',
    API_KEY: '$2a$10$C7BY0Kl0u74gNn/kXO7xNuayWv493/f1jAxlHUmx3ENADQKDii61C'
  };

    // Load picks history from JSONBin (for detailed stats)
  async function loadPicksHistory() {
    if (!JSONBIN_CONFIG.PICKS_HISTORY_BIN_ID) {
      return null;
    }
    try {
      const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.PICKS_HISTORY_BIN_ID}/latest`, {
        headers: { 'X-Access-Key': JSONBIN_CONFIG.API_KEY }
      });
      if (!response.ok) throw new Error('Picks history fetch failed');
      const data = await response.json();
      return data.record?.weeks || [];
    } catch (err) {
      console.warn('Could not load picks history:', err);
      return null;
    }
  }

  // Load from JSONBin (with fallback to local file)
  async function loadFromJSONBin() {
    if (!JSONBIN_CONFIG.SCORES_BIN_ID || JSONBIN_CONFIG.SCORES_BIN_ID === 'YOUR_SCORES_BIN_ID_HERE') {
      return null;
    }
    try {
      const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.SCORES_BIN_ID}/latest`, {
        headers: { 'X-Access-Key': JSONBIN_CONFIG.API_KEY }
      });
      if (!response.ok) throw new Error('JSONBin fetch failed');
      const data = await response.json();
      return data.record || null;
    } catch (err) {
      console.warn('JSONBin fetch failed, falling back to local files:', err);
      return null;
    }
  }

  /* ---------- Utilities ---------- */
  // Optional files: picks.json & schedule.json
  const paths = {
    players: "players.json",
    weeks:   "weeks.json",
    config:  "config.json",
    picks:   "picks.json",   // OPTIONAL ‚Äì for team accuracy & win rate
    schedule:"schedule.json" // OPTIONAL ‚Äì for next game
  };

  // Map NFL team names to logo image paths (add any others you need)
  const teamLogos = {
    "San Francisco 49ers": "Assets/san-francisco-49ers.png",
    "Seattle Seahawks": "Assets/seattle-seahawks.png",
    "Dallas Cowboys": "Assets/dallas-cowboys.png",
    "Philadelphia Eagles": "Assets/philadelphia-eagles.png",
    "Washington Redskins": "Assets/washington-redskins.png",
    "New York Giants": "Assets/new-york-giants.png",
    "Kansas City Chiefs": "Assets/kansas-city-chiefs.png",
    "New England Patriots": "Assets/new-england-patriots.png",
    "Las Vegas Raiders": "Assets/raiders.png",
    "Los Angeles Rams": "Assets/los-angeles-rams.png",
    "Tampa Bay Buccaneers": "Assets/tampa-bay-buccaneers.png",
    "Arizona Cardinals": "Assets/arizona-cardinals.png",
    "Jacksonville Jaguars": "Assets/jacksonville-jaguars.png",
    "Carolina Panthers": "Assets/carolina-panthers.png",
    "Cleveland Browns": "Assets/cleveland-browns.png",
    "Tennessee Titans": "Assets/tennessee-titans.png",
    "Indianapolis Colts": "Assets/indianapolis-colts.png",
    "Chicago Bears": "Assets/chicago-bears.png",
    "Houston Texans": "Assets/houston-texans.png",
    "Los Angeles Chargers": "Assets/los-angeles-chargers.png",
    "Baltimore Ravens": "Assets/baltimore-ravens.png",
    "Buffalo Bills": "Assets/buffalo-bills.png",
    "Cincinnati Bengals": "Assets/cincinnati-bengals.png",
    "Denver Broncos": "Assets/denver-broncos.png",
    "Detroit Lions": "Assets/detroit-lions.png",
    "Green Bay Packers": "Assets/green-bay-packers.png",
    "Minnesota Vikings": "Assets/minnesota-vikings.png",
    "New Orleans Saints": "Assets/new-orleans-saints.png",
    "New York Jets": "Assets/new-york-jets.png",
    "Pittsburgh Steelers": "Assets/pittsburgh-steelers.png",
    "Miami Dolphins": "Assets/miami-dolphins.png",
    "Atlanta Falcons": "Assets/atlanta-falcons.png"
  };

    // ESPN API team IDs for schedule fetching
  const ESPN_TEAM_IDS = {
    "San Francisco 49ers": "25",
    "Seattle Seahawks": "26",
    "Dallas Cowboys": "6",
    "Philadelphia Eagles": "21",
    "Washington Redskins": "28",  // Now Commanders in ESPN
    "Washington Commanders": "28",
    "New York Giants": "19",
    "Kansas City Chiefs": "12",
    "New England Patriots": "17",
    "Las Vegas Raiders": "13",
    "Los Angeles Rams": "14",
    "Tampa Bay Buccaneers": "27",
    "Arizona Cardinals": "22",
    "Jacksonville Jaguars": "30",
    "Carolina Panthers": "29",
    "Cleveland Browns": "5",
    "Tennessee Titans": "10",
    "Indianapolis Colts": "11",
    "Chicago Bears": "3",
    "Houston Texans": "34",
    "Los Angeles Chargers": "24",
    "Baltimore Ravens": "33",
    "Buffalo Bills": "2",
    "Cincinnati Bengals": "4",
    "Denver Broncos": "7",
    "Detroit Lions": "8",
    "Green Bay Packers": "9",
    "Minnesota Vikings": "16",
    "New Orleans Saints": "18",
    "New York Jets": "20",
    "Pittsburgh Steelers": "23",
    "Miami Dolphins": "15",
    "Atlanta Falcons": "1"
  };

  // Cache key for localStorage
  const SCHEDULE_CACHE_KEY = 'nfl_schedule_cache';
  const SCHEDULE_CACHE_DURATION = 1000 * 60 * 60; // 1 hour

    // Load cached schedule from localStorage
  function loadScheduleCache() {
    try {
      const cached = localStorage.getItem(SCHEDULE_CACHE_KEY);
      if (!cached) return null;
      
      const { timestamp, data } = JSON.parse(cached);
      const age = Date.now() - timestamp;
      
      // Return cached data (we'll refresh in background if stale)
      return { data, isStale: age > SCHEDULE_CACHE_DURATION };
    } catch {
      return null;
    }
  }

  // Save schedule to localStorage cache
  function saveScheduleCache(data) {
    try {
      localStorage.setItem(SCHEDULE_CACHE_KEY, JSON.stringify({
        timestamp: Date.now(),
        data
      }));
    } catch (e) {
      console.warn('Could not cache schedule:', e);
    }
  }

  // Fetch schedule for a single team from ESPN API
  async function fetchTeamSchedule(teamId, teamName) {
    try {
      const response = await fetch(
        `https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams/${teamId}/schedule`
      );
      if (!response.ok) throw new Error('ESPN API failed');
      
      const data = await response.json();
      const events = data.events || [];
      
      // Convert ESPN format to our format
      return events.map(event => {
        const competition = event.competitions?.[0];
        const homeTeam = competition?.competitors?.find(c => c.homeAway === 'home');
        const awayTeam = competition?.competitors?.find(c => c.homeAway === 'away');
        
        return {
          home: homeTeam?.team?.displayName || 'TBD',
          away: awayTeam?.team?.displayName || 'TBD',
          date: event.date,
          venue: competition?.venue?.fullName || '',
          completed: competition?.status?.type?.completed || false
        };
      });
    } catch (err) {
      console.warn(`Failed to fetch schedule for ${teamName}:`, err);
      return null;
    }
  }

  // Fetch schedules for all unique teams (with deduplication)
  async function fetchAllSchedules(players) {
    const uniqueTeams = [...new Set(players.map(p => p.team).filter(Boolean))];
    const scheduleMap = {};
    
    // Fetch all teams in parallel
    const results = await Promise.allSettled(
      uniqueTeams.map(async teamName => {
        const teamId = ESPN_TEAM_IDS[teamName];
        if (!teamId) {
          console.warn(`No ESPN ID for team: ${teamName}`);
          return { teamName, games: null };
        }
        const games = await fetchTeamSchedule(teamId, teamName);
        return { teamName, games };
      })
    );
    
    // Build schedule map
    results.forEach(result => {
      if (result.status === 'fulfilled' && result.value.games) {
        scheduleMap[result.value.teamName] = result.value.games;
      }
    });
    
    return scheduleMap;
  }

  // Helper to find team logo even with partial name matches
  function findTeamLogo(teamName) {
    if (!teamName) return null;
    
    // Direct match
    if (teamLogos[teamName]) return teamLogos[teamName];
    
    // Try to find partial match (ESPN might return "49ers" instead of "San Francisco 49ers")
    const searchLower = teamName.toLowerCase();
    for (const [fullName, logoPath] of Object.entries(teamLogos)) {
      if (fullName.toLowerCase().includes(searchLower) || 
          searchLower.includes(fullName.split(' ').pop().toLowerCase())) {
        return logoPath;
      }
    }
    return null;
  }

  // Get next game for a team from the schedule map
  function getNextGameFromMap(scheduleMap, teamName) {
    const games = scheduleMap[teamName];
    if (!games || !games.length) return null;
    
    const now = new Date();
    const upcoming = games
      .filter(g => !g.completed && new Date(g.date) >= now)
      .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (!upcoming.length) return null;
    
    const next = upcoming[0];
    return {
      home: next.home,
      away: next.away,
      dt: new Date(next.date),
      venue: next.venue
    };
  }

  async function loadJSON(path){
    try{
      const res = await fetch(path, { cache: "no-store" });
      if(!res.ok) throw 0;
      return await res.json();
    }catch{
      return null; // optional files may be missing
    }
  }

  // Format a Date to UK local time (BST/GMT as appropriate)
  function formatUK(dt){
    return dt.toLocaleString('en-GB', {
      timeZone: 'Europe/London',
      weekday: 'short',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
      timeZoneName: 'short' // shows BST/GMT
    });
  }

  /* ---------- Compute base tables ---------- */
  function compute({ players, weeks }){
    const playersById = Object.fromEntries(players.map(p=>[p.id,p]));
    const weekNums = [...new Set((weeks||[]).map(w=>w.week))].sort((a,b)=>a-b);

    const totals = players.map(p=>({ id:p.id, name:p.name, avatar:p.avatar, total:0, perWeek:{} }));
    const idx = Object.fromEntries(totals.map(t=>[t.id,t]));

    (weeks||[]).forEach(w=>{
      const scores = w.scores || {};
      for(const [pid,pts] of Object.entries(scores)){
        const t = idx[pid]; if(!t) continue;
        const val = Number(pts);
        if(Number.isFinite(val)){
          t.total += val;
          t.perWeek[w.week] = val; // undefined = DNP; number 0+ = played
        }
      }
    });

    return { playersById, totals, weekNums };
  }

  /* ---------- Leaderboard UI ---------- */
  function medal(rank){
    if(rank===0) return {emoji:"ü•á", color:"from-yellow-400 to-yellow-600", name:"Gold"};
    if(rank===1) return {emoji:"ü•à", color:"from-gray-300 to-gray-500", name:"Silver"};
    if(rank===2) return {emoji:"ü•â", color:"from-amber-600 to-amber-800", name:"Bronze"};
    return null;
  }

  function playerCardHTML(p, rank, view, selectedWeek){
  const m = medal(rank);
  let value = p.total, label = 'Total';
  
  if(view === 'week'){ 
    value = p.perWeek[selectedWeek] ?? 0; 
    
    // Check if it is a special week
    if (selectedWeek === 12.5) {
      label = "Thanksgiving ü¶É";
    } else if (selectedWeek === 16.5) {
      label = "Christmas üéÑ";
    } else {
      label = `Week ${selectedWeek}`;
    }
  }

  return `
    <article class="player-card" data-player="${p.id}">
      ${m ? `<div class="medal-badge bg-gradient-to-b ${m.color}" title="${m.name}">${m.emoji}</div>` : ''}
      <div class="p-4">
        <div class="flex items-center gap-3">
          <img src="${p.avatar}" alt="${p.name}" class="avatar border border-[var(--line)]"/>
          <div class="min-w-0">
            <div class="font-extrabold text-lg truncate">${p.name}</div>
            <button class="open-profile tab-btn mt-1 px-2 py-1 rounded-lg text-xs" data-player="${p.id}">Player Stats</button>
          </div>
        </div>
        <div class="mt-3 grid text-center">
          <div class="rounded-xl border border-[var(--line)] py-3">
            <div class="text-xs opacity-80">${label}</div>
            <div class="text-2xl font-extrabold">${value}</div>
          </div>
        </div>
      </div>
    </article>`;
}

  function renderLeaderboard(totals, view, selectedWeek){
    const sorted = [...totals].sort((a,b)=>{
      if(view==='week') return ((b.perWeek[selectedWeek] ?? 0) - (a.perWeek[selectedWeek] ?? 0));
      return b.total - a.total;
    });
    const html = sorted.map((p,i)=>playerCardHTML(p,i,view,selectedWeek)).join('');
    const root = document.getElementById('leaderboard');
    root.innerHTML = html;

    // selection highlight on card tap/click (doesn't open player stats)
    root.querySelectorAll('.player-card').forEach(card=>{
      card.addEventListener('click', (e)=>{
        if(e.target.closest('.open-profile')) return; // ignore when pressing the button
        card.classList.toggle('selected');
      });
    });
    // open Player Stats
    root.querySelectorAll('.open-profile').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        openProfile(btn.dataset.player);
      });
    });
  }

  /* ---------- Season Highlight & Honorary ---------- */
  function renderHighlight(cfg, playersById){
    const el = document.getElementById('highlight');
    if(!el) return;

    const wId = cfg?.highlight?.winner;
    const sId = cfg?.highlight?.spoon;
    const w = wId && playersById[wId];
    const s = sId && playersById[sId];

    el.innerHTML = `
      <div class="text-center space-y-2">
        <h4 class="font-extrabold text-amber-400 text-xl sm:text-2xl">
          ${cfg?.season ? `${cfg.season} Season Winner!` : 'Season Winner!'}
        </h4>
        ${ w
          ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
               <img src="${w.avatar}" alt="${w.name}" class="w-full h-full object-cover">
             </div>
             <div class="font-extrabold text-lg">${w.name}</div>`
          : `<div class="opacity-60">TBD</div>` }
      </div>
      <div class="text-center space-y-2">
        <h4 class="font-extrabold text-xl sm:text-2xl">ü•Ñ Current Wooden Spoon Holder!</h4>
        ${ s
          ? `<div class="mx-auto w-28 h-28 rounded-full overflow-hidden ring-4 ring-red-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-red-300 hover:shadow-xl">
               <img src="${s.avatar}" alt="${s.name}" class="w-full h-full object-cover">
             </div>
             <div class="font-extrabold text-lg">${s.name}</div>`
          : `<div class="opacity-60">TBD</div>` }
      </div>
    `;
  }

  function renderHonorary(cfg, playersById){
    const el = document.getElementById('honorary');
    if(!el) return;

    const items = (cfg?.honorary || [])
      .slice()
      .sort((a,b)=> b.year - a.year)
      .map(h=>{
        const p = playersById[h.player] || { name:h.player, avatar:'Assets/football2.jpg' };
        return `
          <li class="flex flex-col items-center text-center">
            <div class="w-24 h-24 rounded-full overflow-hidden ring-4 ring-amber-400 shadow-lg transition-transform duration-300 hover:scale-110 hover:ring-amber-300 hover:shadow-xl">
              <img src="${p.avatar}" alt="${p.name}" class="w-full h-full object-cover">
            </div>
            <div class="mt-2 font-semibold">${h.year} - ${p.name}</div>
          </li>`;
      }).join('');

    el.innerHTML = items
      ? `<ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${items}</ul>`
      : '<div class="opacity-60 text-center">No honorary winners yet.</div>';
  }

  /* ---------- Player Stats & helpers ---------- */
  // Only count weeks that actually happened (at least one player scored > 0)
  function computeProfileStats(weeks, playerId, config){
    const playedWeeks = (weeks||[]).filter(w=>{
      const vals = Object.values(w.scores || {}).map(Number).filter(Number.isFinite);
      return vals.some(v => v > 0);
    });

    const perfectMap = config?.perfectWeekPoints || {}; // { "1": 14, ... }
    let total = 0, games = 0;
    let positiveWeeks = 0;
    let bestPoints = -Infinity, bestWeek = null;
    let perfectCount = 0;

    for(const w of playedWeeks){
      const raw = w?.scores?.[playerId];
      if(raw === undefined) continue; // DNP in a week that happened
      const v = Number(raw);
      if(!Number.isFinite(v)) continue;

      total += v;
      games += 1;

      if(v > bestPoints){ bestPoints = v; bestWeek = w.week; }

      if(v > 0){ positiveWeeks += 1; }

      // perfect week target
      let target;
      if(perfectMap[w.week] != null){
        target = Number(perfectMap[w.week]);
      } else if(w.games != null){
        target = Number(w.games);
      } else {
        const vals = Object.values(w.scores||{}).map(n=>Number(n)).filter(Number.isFinite);
        target = vals.length ? Math.max(...vals) : undefined;
      }
      if(Number.isFinite(target) && v === target && v > 0){
        perfectCount += 1;
      }
    }

    if(bestPoints === -Infinity){ bestPoints = 0; bestWeek = null; }

    return {
      totalPoints: total,
      gamesPlayed: games,
      avgPerGame: games ? total/games : 0,
      winRate: games ? Math.round((positiveWeeks / games) * 100) : 0, // fallback if no picks.json
      bestPoints,
      bestWeek,
      perfectWeeks: perfectCount
    };
  }

  // Pick accuracy (per game) from picks history
  function computePickAccuracy(picks, playerId){
    if(!Array.isArray(picks)) return null;
    let correct = 0, total = 0;
    for(const wk of picks){
      for(const g of (wk.games || [])){
        const pick = g?.picks?.[playerId];
        if(!pick || pick === 'missed') continue;
        if(g.winner){
          total += 1;
          if(pick === g.winner) correct += 1;
        }
      }
    }
    if(!total) return null;
    return { correct, total, pct: Math.round((correct/total)*100) };
  }

  // Best team accuracy from picks history
  function computeBestTeamAccuracy(picks, playerId, config){
    if(!Array.isArray(picks)) return null;

    const counts = {}; // team -> { correct: n, total: n }
    for(const wk of picks){
      for(const g of (wk.games || [])){
        const playerPick = g?.picks?.[playerId];
        if(!playerPick || playerPick === 'missed') continue;
        const t = (counts[playerPick] ||= { correct:0, total:0 });
        t.total += 1;
        if(g.winner && g.winner === playerPick) t.correct += 1;
      }
    }
    const minPicks = Number(config?.bestTeamMinPicks ?? 3);

    let best = null;
    for(const [team, stat] of Object.entries(counts)){
      if(stat.total < minPicks) continue;
      const pct = Math.round((stat.correct / stat.total) * 100);
      if(!best || pct > best.pct || (pct === best.pct && stat.total > best.total)){
        best = { team, pct, total: stat.total };
      }
    }
    return best; // { team, pct, total } or null
  }

    // Most picked team (which team does player pick most often)
  function computeMostPickedTeam(picks, playerId){
    if(!Array.isArray(picks)) return null;

    const counts = {}; // team -> count
    for(const wk of picks){
      for(const g of (wk.games || [])){
        const playerPick = g?.picks?.[playerId];
        if(!playerPick || playerPick === 'missed') continue;
        counts[playerPick] = (counts[playerPick] || 0) + 1;
      }
    }

    let mostPicked = null;
    let maxCount = 0;
    for(const [team, count] of Object.entries(counts)){
      if(count > maxCount){
        maxCount = count;
        mostPicked = team;
      }
    }
    
    return mostPicked ? { team: mostPicked, count: maxCount } : null;
  }

  // Current form - last 5 weeks performance (üü¢ = good, üî¥ = bad)
  function computeCurrentForm(weeks, playerId, config){
    if(!Array.isArray(weeks)) return null;

    // Get weeks where player participated, sorted by week number descending
    const playedWeeks = weeks
      .filter(w => {
        const score = w?.scores?.[playerId];
        return score !== undefined && Number.isFinite(Number(score));
      })
      .sort((a, b) => b.week - a.week)
      .slice(0, 5); // Last 5 weeks

    if(playedWeeks.length === 0) return null;

    const form = playedWeeks.map(w => {
      const score = Number(w.scores[playerId]);
      const allScores = Object.values(w.scores || {}).map(Number).filter(Number.isFinite);
      const avgScore = allScores.reduce((a, b) => a + b, 0) / allScores.length;
      
      // Green if at or above average, red if below
      return score >= avgScore ? 'üü¢' : 'üî¥';
    });

    // Reverse so oldest is first (left to right = oldest to newest)
    return form.reverse().join('');
  }
    
// Next upcoming game for a team
  // Now uses scheduleMap (from ESPN API) with fallback to schedule.json
  function nextGameForTeam(schedule, teamName){
    // First try the ESPN schedule map (populated by API)
    if (window.scheduleMap && window.scheduleMap[teamName]) {
      const next = getNextGameFromMap(window.scheduleMap, teamName);
      if (next) return next;
    }
    
    // Fallback to schedule.json (legacy support)
    if(!Array.isArray(schedule) || !teamName) return null;
    const now = new Date();
    const upcoming = schedule
      .map(g => ({ ...g, dt: g?.date ? new Date(g.date) : null }))
      .filter(g => g.dt && g.dt >= now && (g.home === teamName || g.away === teamName))
      .sort((a,b) => a.dt - b.dt);
    return upcoming[0] || null;
  }

  /* ---------- NEW: Fallback win-rate (no picks.json required) ---------- */
  function computeWinPctFromWeeks(weeks, playerId, config){
    if(!Array.isArray(weeks)) return 0;
    let correct = 0, total = 0;

    for(const w of weeks){
      // skip weeks that didn‚Äôt happen (all zeros)
      const vals = Object.values(w.scores || {}).map(Number).filter(Number.isFinite);
      if(!vals.some(v => v > 0)) continue;

      const v = Number(w?.scores?.[playerId]);
      if(!Number.isFinite(v)) continue;

      // perfect target for the week
      let target;
      const map = config?.perfectWeekPoints || {};
      if(map[w.week] != null){
        target = Number(map[w.week]);
      }else if(w.games != null){
        target = Number(w.games);
      }else if(vals.length){
        target = Math.max(...vals); // best available proxy
      }

      if(Number.isFinite(target) && target > 0){
        correct += Math.max(0, Math.min(v, target));
        total   += target;
      }
    }
    return total ? Math.round((correct / total) * 100) : 0;
  }

  /* ---------- Player Stats Modal ---------- */
  function openProfile(playerId){
    const { playersById } = window.state;
    const player = playersById[playerId];
    if(!player) return;

    const stats = computeProfileStats(window.weeks, playerId, window.config || {});
    const pickAcc = computePickAccuracy(window.picks, playerId); // uses picks.json when available
    const bestTeam = computeBestTeamAccuracy(window.picks, playerId, window.config || {});
    const next = nextGameForTeam(window.schedule, player.team);

    // Header bits
    document.getElementById('profAvatar').src = player.avatar;
    document.getElementById('profAvatar').alt = player.name;
    document.getElementById('profName').textContent = player.name;

    // Team pill
    const teamWrap = document.getElementById('profTeam');
    if(player.team || player.teamLogo){
      teamWrap.innerHTML = `
        <span class="team-pill">
          ${player.teamLogo ? `<img src="${player.teamLogo}" alt="" class="object-contain rounded-sm">` : ''}
          <span>${player.team || 'Team'}</span>
        </span>`;
    } else {
      teamWrap.innerHTML = '';
    }

    // Next game (in UK time)
    const nextEl = document.getElementById('nextGame');
    if(next){
      const opp = (next.home === player.team) ? next.away : next.home;
      const dateStr = formatUK(next.dt);

      nextEl.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm opacity-80">Next game</div>
          <div class="text-right text-sm opacity-80">
            ${dateStr}${next.venue ? ` ¬∑ ${next.venue}` : ''}
          </div>
        </div>

        <div class="mt-2 next-row">
          <div class="team team--home">
            ${player.teamLogo ? `<img src="${player.teamLogo}" class="w-8 h-8 object-contain" alt="">` : ''}
            <span class="team-name">${player.team}</span>
          </div>

          <span class="vs-badge" aria-hidden="true">VS</span>

          <div class="team team--away">
            ${findTeamLogo(opp) ? `<img src="${findTeamLogo(opp)}" class="w-8 h-8 object-contain" alt="">` : ''}
            <span class="team-name">${opp}</span>
          </div>
        </div>
      `;
      nextEl.classList.remove('hidden');
    } else {
      nextEl.classList.add('hidden');
      nextEl.innerHTML = '';
    }

    // Calculate new stats
    const mostPicked = computeMostPickedTeam(window.picks, playerId);
    const currentForm = computeCurrentForm(window.weeks, playerId, window.config || {});
    const fallbackPct = computeWinPctFromWeeks(window.weeks, playerId, window.config || {});

    // Win Rate
    document.getElementById('statWinRate').textContent =
      pickAcc ? `${pickAcc.pct}%` : `${fallbackPct}%`;

    // Best Team Accuracy (show team name + percentage)
    document.getElementById('statBestTeam').textContent = bestTeam
      ? `${bestTeam.team.split(' ').pop()} (${bestTeam.pct}%)`
      : '‚Äî';

    // Correct Picks (e.g., "89/134")
    document.getElementById('statCorrectPicks').textContent = pickAcc
      ? `${pickAcc.correct}/${pickAcc.total}`
      : '‚Äî';

    // Most Picked Team
    document.getElementById('statMostPicked').textContent = mostPicked
      ? `${mostPicked.team.split(' ').pop()} (${mostPicked.count})`
      : '‚Äî';

    // Current Form (last 5 weeks)
    document.getElementById('statCurrentForm').textContent = currentForm || '‚Äî';

    // Perfect Weeks
    document.getElementById('statPerfect').textContent = stats.perfectWeeks;

    // NFL Regular Season Wins
    document.getElementById('statNFLWins').textContent =
      Number.isFinite(Number(player.nflWins)) ? Number(player.nflWins) : 0;

    // Super Bowl Wins
    document.getElementById('statSBWins').textContent =
      Number.isFinite(Number(player.superbowlWins)) ? Number(player.superbowlWins) : 0;

    // Show modal & lock scroll
    document.getElementById('profileModal').classList.add('open');
    document.body.classList.add('no-scroll');
    document.getElementById('profileModal').setAttribute('aria-hidden','false');
  }

/* ---------- Boot ---------- */
  (async function boot(){
    try{
      // Always load players from local file
      const players = await loadJSON(paths.players);
      
      // Try to load weeks and config from JSONBin first
      let weeks, config;
      const jsonBinData = await loadFromJSONBin();
      
      if (jsonBinData && jsonBinData.weeks && jsonBinData.weeks.length > 0) {
        // Use JSONBin data for weeks
        weeks = jsonBinData.weeks;
        // Merge JSONBin config with local config
        const localConfig = await loadJSON(paths.config) || {};
        config = {
          ...localConfig,
          perfectWeekPoints: {
            ...(localConfig.perfectWeekPoints || {}),
            ...(jsonBinData.config?.perfectWeekPoints || {})
          }
        };
        console.log('‚úÖ Loaded scores from JSONBin');
      } else {
        // Fall back to local files
        weeks = await loadJSON(paths.weeks);
        config = await loadJSON(paths.config);
        console.log('üìÅ Using local data files');
      }

      // Load picks history from JSONBin (replaces local picks.json)
      const picksHistory = await loadPicksHistory();
      const picks = picksHistory || await loadJSON(paths.picks);
      if (picksHistory) {
        console.log('‚úÖ Loaded picks history from JSONBin');
      }
      
      // Schedule: Load from cache first, then refresh from ESPN API in background
      let schedule = null;
      window.scheduleMap = {}; // Will hold ESPN data by team
      
      const cached = loadScheduleCache();
      if (cached?.data) {
        window.scheduleMap = cached.data;
        console.log('üìÖ Loaded schedule from cache' + (cached.isStale ? ' (refreshing...)' : ''));
      }
      
      // Always try to refresh from ESPN (in background if we have cache)
      const fetchSchedules = async () => {
        try {
          const freshData = await fetchAllSchedules(players);
          if (Object.keys(freshData).length > 0) {
            window.scheduleMap = freshData;
            saveScheduleCache(freshData);
            console.log('‚úÖ Schedule updated from ESPN API');
          }
        } catch (err) {
          console.warn('ESPN schedule fetch failed:', err);
        }
      };
      
      if (cached?.data && !cached.isStale) {
        // Cache is fresh, refresh in background (don't block)
        fetchSchedules();
      } else {
        // No cache or stale, fetch now (might block briefly)
        await fetchSchedules();
      }
      
      // Legacy fallback (schedule.json)
      schedule = await loadJSON(paths.schedule);

      window.weeks = weeks || [];
      window.config = config || {};
      window.picks = picks || null;
      window.schedule = schedule || null;

      const state = compute({ players, weeks });
      window.state = state;

      // Build week dropdown (ascending) and default it to Week 1
const weekSel = document.getElementById('weekSelect');
const totalBtn = document.getElementById('totalBtn');

// UPDATED LOGIC: Checks for special weeks
weekSel.innerHTML = state.weekNums.map(w => {
  let label;
  if (w === 12.5) {
    label = "Thanksgiving ü¶É";
  } else if (w === 16.5) {
    label = "Christmas üéÑ";
  } else {
    label = `Week ${w}`;
  }
  return `<option value="${w}">${label}</option>`;
}).join('');

if(state.weekNums.length){ weekSel.value = String(state.weekNums[0]); } // Week 1

      // Initial renders
      renderLeaderboard(state.totals, 'total'); // Always start on All
      renderHighlight(config, state.playersById);
      renderHonorary(config, state.playersById);

      // Keep defaulting to All even on bfcache returns
      function resetToAll(){
        totalBtn.setAttribute('aria-selected','true');
        if(state.weekNums.length) weekSel.selectedIndex = 0; // show "Week 1"
        renderLeaderboard(state.totals, 'total');
      }
      resetToAll();
      window.addEventListener('pageshow', resetToAll);

      // Interactions
      totalBtn.addEventListener('click', ()=>{
        totalBtn.setAttribute('aria-selected','true');
        renderLeaderboard(state.totals, 'total');
      });
      weekSel.addEventListener('change', ()=>{
        totalBtn.setAttribute('aria-selected','false');
        renderLeaderboard(state.totals, 'week', Number(weekSel.value));
      });

      // Rules modal
      const rulesModal = document.getElementById('rulesModal');
      function openRules(){
        rulesModal.classList.add('open');
        document.body.classList.add('no-scroll');
        rulesModal.setAttribute('aria-hidden','false');
      }
      function closeRules(){
        rulesModal.classList.remove('open');
        document.body.classList.remove('no-scroll');
        rulesModal.setAttribute('aria-hidden','true');
      }
      document.getElementById('rulesBtn').addEventListener('click', openRules);
      document.getElementById('closeRules').addEventListener('click', closeRules);
      rulesModal.addEventListener('click', e=>{ if(e.target===rulesModal) closeRules(); });

      // Player stats modal
      const profileModal = document.getElementById('profileModal');
      function closeProfile(){
        profileModal.classList.remove('open');
        document.body.classList.remove('no-scroll');
        profileModal.setAttribute('aria-hidden','true');
      }
      document.getElementById('profileClose').addEventListener('click', closeProfile);
      profileModal.addEventListener('click', e=>{ if(e.target===profileModal) closeProfile(); });

      // Metric help toggle
      const metricHelpBtn = document.getElementById('metricHelpBtn');
      const metricHelp = document.getElementById('metricHelp');
      metricHelpBtn.addEventListener('click', ()=>{
        metricHelp.classList.toggle('hidden');
      });

      // Repo link + footer year
      const repoLink = document.getElementById('repoLink');
      if(repoLink) repoLink.href = config?.repoUrl || '#';
      document.getElementById('copyrightYear').textContent = new Date().getFullYear();

    }catch(err){
      console.error(err);
      const msg = document.createElement('div');
      msg.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-xl text-sm shadow-lg';
      msg.textContent = err?.message || 'Something went wrong';
      document.body.appendChild(msg);
    }
  })();
  </script>
</body>
</html>
